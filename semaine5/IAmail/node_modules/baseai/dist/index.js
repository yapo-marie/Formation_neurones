#!/usr/bin/env node
import _l from"dotenv";import kl from"path";import Zs from"figures";import y from"picocolors";var Nl={info:y.cyan,success:y.green,warning:y.yellow,error:y.red,green:y.green,red:y.red,yellow:y.yellow,cyan:y.cyan,blue:y.blue,magenta:y.magenta,white:y.white,gray:y.gray,dim:y.dim,bold:y.bold},te=e=>y.italic(y.dim(e)),xe=y.dim,Fl=y.bold,jl=y.underline,Gl=y.italic,Bl=y.inverse,ql=y.hidden,Ul=y.strikethrough,Hl=y.reset,Jl=y.black,Kl=y.red,xo=y.green,Vl=y.yellow,zl=y.blue,Xl=y.magenta,X=y.cyan,Yl=y.white,Wl=y.gray;var jt=y.dim(`${Zs.lineUpDownRight} `);import Gt from"fs";import ei from"path";async function Bt(){let e=ei.join(process.cwd(),"baseai","pipes");return Gt.existsSync(e)?(await Gt.promises.readdir(e)).map(r=>r.replace(".ts","")):[]}import qt from"fs";import oi from"path";async function Le(){let e=oi.join(process.cwd(),"baseai","tools");return qt.existsSync(e)?(await qt.promises.readdir(e)).map(r=>r.replace(".ts","")):[]}import Me from"picocolors";function h({text:e,sub:o,dim:t,green:r}){return r?`${Me.bgGreen(Me.black(` ${e} `))} ${o&&o}`:t?`${Me.bgBlack(Me.white(` ${e} `))} ${o&&o}`:`${Me.bold(Me.bgCyan(Me.black(` ${e} `)))} ${o&&o}`}import et from"figures";var ti={pipe:et.lineDownDoubleRightDouble,tool:et.lineDownLeftBoldRightBold,memory:et.nodejs},Ee=ti;import Ut from"@sindresorhus/slugify";function wo({name:e,allTools:o}){return o.some(t=>Ut(t)===Ut(e))}import*as ot from"@clack/prompts";import{cosmiconfig as ri}from"cosmiconfig";import{TypeScriptLoader as ni}from"cosmiconfig-typescript-loader";var We={log:{isEnabled:!0,logSensitiveData:!1,pipe:!0,"pipe.completion":!0,"pipe.request":!0,"pipe.response":!0,tool:!0,memory:!0},memory:{useLocalEmbeddings:!1},envFilePath:".env"};async function W(){let e=ri("baseai",{searchPlaces:["baseai/baseai.config.ts"],loaders:{".ts":ni()}});try{let o=await e.search();o||(ot.cancel("Failed to create config file"),process.exit(1));let t=o.config.config;if(t)return{...We,...t,log:{...We.log,...t.log}}}catch{ot.cancel("Error: Unable to load config file"),process.exit(1)}return We}import si from"fs/promises";import*as Po from"@clack/prompts";import ii from"picocolors";function ai({spinner:e}){e.stop("No account found"),Po.log.warn("No account found. Please authenticate first."),Po.log.info(`Run: ${ii.green("npx baseai auth")}`)}function pi({spinner:e,error:o}){e.stop("Failed to retrieve authentication"),Po.log.error(`Error retrieving stored auth: ${o.message}`)}async function Ae({spinner:e}){var o;e.start("Retrieving stored authentication");try{let r=(await W()).envFilePath||".env",s=(o=(await si.readFile(r,"utf-8")).split(`
`).reverse().find(i=>i.includes("LANGBASE_API_KEY=")))==null?void 0:o.split("=")[1];return s?(e.stop("Retrieved stored authentication"),{apiKey:s}):(ai({spinner:e}),null)}catch(t){return pi({spinner:e,error:t}),null}}import*as Ht from"prettier";async function we(e){return await Ht.format(e,{parser:"typescript",singleQuote:!0,trailingComma:"none",arrowParens:"avoid",printWidth:80,useTabs:!0,semi:!0,tabWidth:4})}import*as v from"@clack/prompts";import tt from"@sindresorhus/slugify";import rt from"camelcase";import li from"figures";import vo from"fs";import mi from"p-map";import Eo from"path";import So from"picocolors";function ci(e){if(!e)return{login:"",name:""};let o=e.split("/"),t=o.length;return t<2?{login:"",name:""}:{login:o[t-2],name:o[t-1]}}async function di({login:e,name:o,spinner:t}){var r;try{let n=await Ae({spinner:t});if(!n){v.log.error('Authentication failed. Please run "npx baseai auth" to authenticate.');return}t.start("Fetching pipe from Langbase");let s=`https://api.langbase.com/v1/pipes/${e}/${o}`,i=await fetch(s,{method:"GET",headers:{"Content-Type":"application/json",...n&&{Authorization:`Bearer ${n.apiKey}`}}});if(i.ok)return t.stop("Fetched pipe from Langbase"),await i.json();let a=await i.json();a&&(t.stop(`Failed to fetch pipe from Langbase: ${(r=a.error)==null?void 0:r.message}`),process.exit(1))}catch(n){return t.stop(n),null}}async function ui(e){if(!e.tools.length)return;let o=await Le();try{await mi(e.tools,async t=>{if(wo({name:t.function.name,allTools:o})&&!(await v.group({overwrite:()=>v.confirm({message:`${So.dim(Ee.tool)} Tool: ${So.cyan(t.function.name)} already exists. Do you want to overwrite it?`,initialValue:!1})},{onCancel:()=>{v.cancel("Operation cancelled."),process.exit(0)}})).overwrite){v.outro("Skipped \u2026");return}let n=t.function.name,s=rt(n),i=tt(n),a=`import { ToolI } from '@baseai/core';

			export async function ${n}() {
				// Your tool logic here
			}

			const ${s}Tool = (): ToolI => ({
				run: ${n}, // Name of the function to run
				type: 'function' as const,
				function: {
					name: \`${n}\`,
					description: \`${t.function.description}\`,
					parameters: ${JSON.stringify(t.function.parameters||{},null,6)}
				}
			});

			export default ${s}Tool;`,p=await we(a),l=Eo.join(process.cwd(),"baseai","tools"),m=Eo.join(l,`${i}.ts`);await vo.promises.mkdir(l,{recursive:!0}),await vo.promises.writeFile(m,p),v.outro(`Tool created successfully at ${m}`)},{concurrency:1})}catch(t){v.cancel(`Error creating tool: ${t.message}`)}}function fi(e){return e.map(o=>{let t=tt(o.function.name),r=`${rt(o.function.name)}Tool`,n=`import ${r} from '../tools/${t}';`;return{toolCall:`${r}()`,importPath:n,toolFileName:t}})}async function gi(e){try{let o=await Bt(),t=tt(e.name);if(o.some(d=>d===t)&&!(await v.group({overwrite:()=>v.confirm({message:`PIPE: ${So.cyan(e.name)} already exists. Do you want to overwrite it?`,initialValue:!1})},{onCancel:()=>{v.cancel("Operation cancelled."),process.exit(0)}})).overwrite){v.outro("Skipped \u2026");return}let n=await fi(e.tools),s=n.map(d=>d.toolCall),i=rt("pipe-"+e.name),a=e.messages.map(d=>({...d.name&&{name:d.name},role:d.role,content:d.content})),p=`import { PipeI } from '@baseai/core';
${n.map(d=>d.importPath).join(`
`)}

		const ${i} = (): PipeI => ({
			// Replace with your API key https://langbase.com/docs/api-reference/api-keys
			apiKey: process.env.LANGBASE_API_KEY!,
			name: \`${e.name}\`,
			description: \`${e.description}\`,
			status: \`${e.status}\`,
			model: \`${e.model}\`,
			stream: ${e.stream},
			json: ${e.json},
			store: ${e.store},
			moderate: ${e.moderate||!0},
			top_p: ${e.top_p},
			max_tokens: ${e.max_tokens},
			temperature: ${e.temperature},
			presence_penalty: ${e.presence_penalty},
			frequency_penalty: ${e.frequency_penalty},
			stop: ${JSON.stringify(e.stop)},
			tool_choice: ${JSON.stringify(e.tool_choice)},
			parallel_tool_calls: ${e.parallel_tool_calls},
			messages: ${JSON.stringify(a||[])},
			variables: ${JSON.stringify(e.variables)},
			tools: [${s}],
			memory: [],
		});

		export default ${i};`,l=await we(p),m=Eo.join(process.cwd(),"baseai","pipes"),c=Eo.join(m,`${t}.ts`);await vo.promises.mkdir(m,{recursive:!0}),await vo.promises.writeFile(c,l),v.outro(`Pipe created successfully at ${c}`),v.outro(h({text:t,sub:`pipe added 
 ${xe(li.pointer)} ${te(` ${c}`)}`,green:!0})),process.exit(0)}catch(o){v.cancel(`Error creating pipe: ${o.message}`)}}async function Jt({loginAndPipe:e}){v.intro(h({text:"PIPE",sub:`Adding ${So.cyan(e)}`}));let{login:o,name:t}=ci(e);if(!o||!t){v.log.error("Invalid pipe information provided");return}let r=v.spinner();try{let n=await di({login:o,name:t,spinner:r});if(!n)return;await ui(n),await gi(n)}catch(n){r.stop("An unexpected error occurred"),v.log.error(`'An unexpected error occurred': ${n.message}`)}}import*as zt from"@clack/prompts";import{cancel as nt,confirm as Kt,isCancel as st,note as hi,outro as it,password as yi}from"@clack/prompts";import at from"fs/promises";import Ci from"open";import Vt from"path";import Qe from"picocolors";async function Xt(){var m;zt.intro(h({text:"Langbase Authentication",sub:"Auth by logging in to Langbase and getting your API key"}));let e=await Kt({message:`Open the authentication page? ${Qe.dim("\u2014 copy your API key from there and paste it here.")}`});st(e)&&(nt("Operation cancelled."),process.exit(0)),e&&(await Ci("https://langbase.com/settings/api"),hi(Qe.yellow("Please copy your API key from the opened page and paste it here.")));let o=await yi({message:"Paste your API key string:",mask:"*"});st(o)&&(nt("Operation cancelled."),process.exit(0));let[t,r]=o.split(":");(!t||!r)&&(it(Qe.red("Invalid API key string. It should be in the format login:apiKey, when copied from https://langbase.com/settings/api it should be in the correct format.")),process.exit(1));let s=`
# Langbase API key for https://langbase.com/${t}
LANGBASE_API_KEY=${r}

`,a=(await W()).envFilePath||".env",p=await at.readFile(a,"utf-8"),l=(m=p.split(`
`).reverse().find(c=>c.includes("LANGBASE_API_KEY")))==null?void 0:m.split("=")[1];if(l){let c=await Kt({message:`API key found in ${a}. Overwrite?`});st(c)&&(nt("Operation cancelled."),process.exit(0)),c||(it(Qe.yellow("API key is not overwritten.")),process.exit(0));let d=p.replace(new RegExp(`LANGBASE_API_KEY=${l}`),s.trim());await at.writeFile(Vt.join(process.cwd(),a),d)}else await at.appendFile(Vt.join(process.cwd(),a),s);it(Qe.green(`Authentication successful. API key is stored in ${a}`)),process.exit(0)}import*as N from"@clack/prompts";import{exec as bi}from"child_process";import re from"fs/promises";import L from"path";import{promisify as xi}from"util";var Yt=xi(bi);async function wi({calledAsCommand:e}){try{e&&N.intro(h({text:"BUILDING",sub:"baseai..."})),await Pi(),await vi(),await Ze(),console.log(""),N.outro(h({text:"BUILD",sub:"complete",green:!0}))}catch(o){throw N.log.error("Build failed"),o}}var Mo=wi,Pi=async()=>{console.log(""),N.intro(h({text:"PIPES",sub:"",dim:!0}));let e=L.join(process.cwd(),"baseai","pipes"),o=L.join(process.cwd(),".baseai","pipes"),t=await Wt(e,o,"pipes");pt("Pipes",t,Ee.pipe)},vi=async()=>{console.log(""),N.intro(h({text:"TOOLS",sub:"",dim:!0}));let e=L.join(process.cwd(),"baseai","tools"),o=L.join(process.cwd(),".baseai","tools"),t=await Wt(e,o,"tools");pt("Tools",t,Ee.tool)},Ze=async({memoryName:e}={})=>{console.log(""),N.intro(h({text:"MEMORY",sub:"",dim:!0}));let o=L.join(process.cwd(),"baseai","memory"),t=L.join(process.cwd(),".baseai","memory");try{await re.access(o)}catch{N.log.info("No memory directory found. Skipping memory build.");return}try{await re.access(t)}catch{await re.mkdir(t,{recursive:!0})}let r=[],n=N.spinner(),s=[];if(e&&(s=await Ei({sourcePath:o,memoryName:e})),!e&&(s=await Si(o),s.length===0)){N.log.info("MEMORY: No index.ts file found. Skipping memory build.");return}n.start("Building memory");for(let i of s){let a=L.join(o,i),p=L.join(t,`${L.dirname(i)}.json`),l=L.dirname(i);try{let{stdout:m}=await Yt(`npx tsx -e "import memoryConfig from '${JSON.stringify(a)}'; console.log(JSON.stringify(memoryConfig()))"`);await re.writeFile(p,m),n.message(`Compiled ${l}`),r.push(l)}catch(m){n.stop(`Error compiling ${l}: ${m}`)}}n.stop("Build complete"),pt("Memories",r,Ee.memory)},Wt=async(e,o,t)=>{try{await re.access(e)}catch{return N.log.info(`No ${t} directory found. Skipping ${t} build.`),[]}await re.mkdir(o,{recursive:!0});let n=(await re.readdir(e)).filter(a=>a.endsWith(".ts"));if(n.length===0)return N.log.info(`No .ts files found in the ${t} directory. Skipping ${t} build.`),[];let s=N.spinner();s.start(`Building ${t}`);let i=[];for(let a of n){let p=L.join(e,a),l=L.join(o,a.replace(".ts",".json")),m=L.parse(a).name;try{let{stdout:c}=await Yt(`npx tsx -e "import config from '${JSON.stringify(p)}'; console.log(JSON.stringify(config()))"`),d=JSON.parse(c);"apiKey"in d&&delete d.apiKey;let f=JSON.stringify(d,null,2);await re.writeFile(l,f),s.message(`Compiled ${m}`),i.push(m)}catch(c){s.stop(`Error compiling ${m}: ${c}`)}}return s.stop("Build complete"),i},pt=(e,o,t)=>{o.length>0&&o.forEach(r=>{console.log(`${t}  ${r}`)})};async function Ei({sourcePath:e,memoryName:o}){let t=[],r=L.join(e,o),s=(await re.readdir(r)).find(i=>i==="index.ts");return s||(N.log.info("MEMORY: No index.ts file found. Skipping memory build."),process.exit(1)),t.push(L.join(o,s)),t}async function Si(e){let o=[],r=(await re.readdir(e)).map(async i=>{let a=L.join(e,i);return(await re.stat(a)).isDirectory()?i:""}),n=await Promise.all(r);if(n=n.filter(i=>i!==""),n.length===0)return N.log.info("MEMORY: No memory found. Skipping memory build."),[];let s=n.map(async i=>{let a=L.join(e,i),l=(await re.readdir(a)).find(m=>m==="index.ts");return l?L.join(i,l):""});return o=await Promise.all(s),o=o.filter(i=>i!==""),o}var T="OpenAI",q="Anthropic",I="Together",_="Google",F="Groq",j="Cohere",E="Fireworks AI",R="Perplexity",pe="Mistral AI",Qt="deepinfra",Zt="bedrock",er="azure-openai",K="ollama",Ne="xAI",Ym={[T]:[{id:"gpt-4o",provider:T,promptCost:5,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4o-2024-08-06",provider:T,promptCost:2.5,completionCost:10,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4o-mini",provider:T,promptCost:.15,completionCost:.6,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-turbo",provider:T,promptCost:10,completionCost:30,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-turbo-preview",provider:T,promptCost:10,completionCost:30,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-0125-preview",provider:T,promptCost:10,completionCost:30,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-1106-preview",provider:T,promptCost:10,completionCost:30,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4",provider:T,promptCost:30,completionCost:60,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-0613",provider:T,promptCost:30,completionCost:60,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-32k",provider:T,promptCost:60,completionCost:120,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-3.5-turbo",provider:T,promptCost:.5,completionCost:1.5,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-3.5-turbo-0125",provider:T,promptCost:.5,completionCost:1.5,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-3.5-turbo-1106",provider:T,promptCost:1,completionCost:2,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-3.5-turbo-16k",provider:T,promptCost:3,completionCost:4,toolSupport:{toolChoice:!0,parallelToolCalls:!0}}],[I]:[{id:"meta-llama/Llama-3.3-70B-Instruct-Turbo",provider:I,promptCost:.88,completionCost:.88},{id:"meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo",provider:I,promptCost:5,completionCost:5,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo",provider:I,promptCost:.88,completionCost:.88,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo",provider:I,promptCost:.18,completionCost:.18,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"meta-llama/Llama-3-70b-chat-hf",provider:I,promptCost:.9,completionCost:.9},{id:"meta-llama/Llama-3-8b-chat-hf",provider:I,promptCost:.2,completionCost:.2},{id:"togethercomputer/Llama-2-7B-32K-Instruct",provider:I,promptCost:.2,completionCost:.2},{id:"meta-llama/Llama-2-13b-chat-hf",provider:I,promptCost:.225,completionCost:.225},{id:"meta-llama/Llama-2-70b-chat-hf",provider:I,promptCost:.9,completionCost:.9},{id:"google/gemma-7b-it",provider:I,promptCost:.2,completionCost:.2},{id:"google/gemma-2b-it",provider:I,promptCost:.1,completionCost:.1},{id:"mistralai/Mistral-7B-Instruct-v0.1",provider:I,promptCost:.2,completionCost:.2,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"mistralai/Mistral-7B-Instruct-v0.2",provider:I,promptCost:.2,completionCost:.2},{id:"mistralai/Mixtral-8x7B-Instruct-v0.1",provider:I,promptCost:.6,completionCost:.6,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"mistralai/Mixtral-8x22B-Instruct-v0.1",provider:I,promptCost:1.2,completionCost:1.2},{id:"databricks/dbrx-instruct",provider:I,promptCost:1.2,completionCost:1.2}],[q]:[{id:"claude-3-5-sonnet-latest",provider:q,promptCost:3,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-5-sonnet-20240620",provider:q,promptCost:3,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-opus-20240229",provider:q,promptCost:15,completionCost:75,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-sonnet-20240229",provider:q,promptCost:3,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-haiku-20240307",provider:q,promptCost:.25,completionCost:1.25,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-5-haiku-20241022",provider:q,promptCost:1,completionCost:5,toolSupport:{toolChoice:!0,parallelToolCalls:!0}}],[F]:[{id:"llama-3.3-70b-versatile",provider:F,promptCost:.59,completionCost:.79},{id:"llama-3.1-70b-versatile",provider:F,promptCost:.59,completionCost:.79},{id:"llama-3.1-8b-instant",provider:F,promptCost:.59,completionCost:.79},{id:"llama3-70b-8192",provider:F,promptCost:.59,completionCost:.79},{id:"llama3-8b-8192",provider:F,promptCost:.05,completionCost:.1},{id:"mixtral-8x7b-32768",provider:F,promptCost:.27,completionCost:.27},{id:"gemma2-9b-it",provider:F,promptCost:.2,completionCost:.2},{id:"gemma-7b-it",provider:F,promptCost:.07,completionCost:.07}],[_]:[{id:"gemini-1.5-pro-latest",provider:_,promptCost:3.5,completionCost:10.5,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gemini-1.5-flash-latest",provider:_,promptCost:.075,completionCost:.3,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gemini-1.5-flash-8b-latest",provider:_,promptCost:.0375,completionCost:.15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gemini-pro",provider:_,promptCost:.5,completionCost:1.5,toolSupport:{toolChoice:!1,parallelToolCalls:!1}}],[j]:[{id:"command-r",provider:j,promptCost:.5,completionCost:1.5},{id:"command-r-plus",provider:j,promptCost:3,completionCost:15}],[E]:[{id:"llama-v3p3-70b-instruct",provider:E,promptCost:.88,completionCost:.88},{id:"llama-v3p1-405b-instruct",provider:E,promptCost:3,completionCost:3},{id:"llama-v3p1-70b-instruct",provider:E,promptCost:.9,completionCost:.9},{id:"llama-v3p1-8b-instruct",provider:E,promptCost:.2,completionCost:.2},{id:"yi-large",provider:E,promptCost:3,completionCost:3},{id:"llama-v3-70b-instruct",provider:E,promptCost:.9,completionCost:.9}],[R]:[{id:"llama-3.1-sonar-huge-128k-online",provider:R,promptCost:5,completionCost:5,requestCost:.005},{id:"llama-3.1-sonar-large-128k-online",provider:R,promptCost:1,completionCost:1,requestCost:.005},{id:"llama-3.1-sonar-small-128k-online",provider:R,promptCost:.2,completionCost:.2,requestCost:.005},{id:"llama-3.1-sonar-large-128k-chat",provider:R,promptCost:1,completionCost:1},{id:"llama-3.1-sonar-small-128k-chat",provider:R,promptCost:.2,completionCost:.2}],[pe]:[{id:"mistral-large-latest",provider:pe,promptCost:3,completionCost:9},{id:"open-mistral-nemo",provider:pe,promptCost:.3,completionCost:.3},{id:"codestral-latest",provider:pe,promptCost:1,completionCost:3}],[Ne]:[{id:"grok-beta",provider:Ne,promptCost:5,completionCost:15}]},or=["gpt-4o","gpt-4o-mini-2024-07-18-free","gpt-4o-2024-08-06","gpt-4o-mini","gpt-4-turbo","gpt-4-turbo-preview","gpt-4-0125-preview","gpt-3.5-turbo","gpt-3.5-turbo-0125","gpt-3.5-turbo-1106","gpt-4-1106-preview","mistralai/Mistral-7B-Instruct-v0.1","mistralai/Mixtral-8x7B-Instruct-v0.1","gemini-1.5-pro-latest","gemini-1.5-flash-latest"];import Ie from"chalk";import Mi from"util";var Ai=!1,Ii=!1,Ti=["sensitive","secret","hide","private","password","token","key","auth","authorization","redact"],_i=e=>typeof e=="object"&&e!==null?Mi.inspect(e,{colors:!0,depth:null}):typeof e=="string"?Ie.green(`"${e}"`):typeof e=="number"?Ie.yellow(e.toString()):typeof e=="boolean"?Ie.cyan(e.toString()):String(e),ki=e=>Ti.some(o=>e.toLowerCase().includes(o)),Ri=(e,o)=>o&&!Ii?Ie.red("======REDACTED======"):_i(e),tr=(e,o,t)=>{let r=Ri(o,!!t&&ki(t||e));console.log(`
${Ie.blue("======")} \u{1F440} ${Ie.bold(e)} \u{1F440} ${Ie.blue("======")}`),console.log(r)},u=(e,o,t)=>{Ai&&(typeof e=="object"&&e!==null&&o===void 0?Object.entries(e).forEach(([r,n])=>tr(r,n,t||r)):tr(String(e),o,t))};function Ao({localDocs:e,prodDocs:o}){let t=new Set(e),r=new Set(o),n=t.size===r.size&&e.every(l=>r.has(l)),s=o.every(l=>t.has(l)),i=e.every(l=>r.has(l)),a=!e.some(l=>r.has(l))&&!o.some(l=>t.has(l)),p=e.some(l=>r.has(l));return{areListsSame:n,isProdSubsetOfLocal:s,isProdSupersetOfLocal:i,areMutuallyExclusive:a,areOverlapping:p}}var rr=[".md",".txt",".pdf",".csv",".xlsx",".xls"],Oi={".json":"JSON",".yaml":"YAML",".yml":"YAML",".xml":"XML",".html":"HTML",".htm":"HTML",".abap":"ABAP",".asc":"AGS Script",".ash":"AGS Script",".ampl":"AMPL",".mod":"Modula-2",".g4":"ANTLR",".apl":"APL",".dyalog":"APL",".asp":"ASP",".asax":"ASP",".ascx":"ASP",".ashx":"ASP",".asmx":"ASP",".aspx":"ASP",".axd":"ASP",".dats":"ATS",".hats":"ATS",".sats":"ATS",".as":"ActionScript",".adb":"Ada",".ada":"Ada",".ads":"Ada",".agda":"Agda",".als":"Alloy",".cls":"Visual Basic",".applescript":"AppleScript",".scpt":"AppleScript",".arc":"Arc",".ino":"Arduino",".aj":"AspectJ",".asm":"Assembly",".a51":"Assembly",".inc":"SourcePawn",".nasm":"Assembly",".aug":"Augeas",".ahk":"AutoHotkey",".ahkl":"AutoHotkey",".au3":"AutoIt",".awk":"Awk",".auk":"Awk",".gawk":"Awk",".mawk":"Awk",".nawk":"Awk",".bat":"Batchfile",".cmd":"Batchfile",".befunge":"Befunge",".bison":"Bison",".bb":"BlitzBasic",".decls":"BlitzBasic",".bmx":"BlitzMax",".bsv":"Bluespec",".boo":"Boo",".b":"Limbo",".bf":"HyPhy",".brs":"Brightscript",".bro":"Bro",".c":"C",".cats":"C",".h":"Objective-C",".idc":"C",".w":"C",".cs":"Smalltalk",".cake":"CoffeeScript",".cshtml":"C#",".csx":"C#",".cpp":"C++",".c++":"C++",".cc":"C++",".cp":"Component Pascal",".cxx":"C++",".h++":"C++",".hh":"Hack",".hpp":"C++",".hxx":"C++",".inl":"C++",".ipp":"C++",".tcc":"C++",".tpp":"C++",".chs":"C2hs Haskell",".clp":"CLIPS",".cmake":"CMake",".cmake.in":"CMake",".cob":"COBOL",".cbl":"COBOL",".ccp":"COBOL",".cobol":"COBOL",".cpy":"COBOL",".capnp":"Cap'n Proto",".mss":"CartoCSS",".ceylon":"Ceylon",".chpl":"Chapel",".ch":"xBase",".ck":"ChucK",".cirru":"Cirru",".clw":"Clarion",".icl":"Clean",".dcl":"Clean",".click":"Click",".clj":"Clojure",".boot":"Clojure",".cl2":"Clojure",".cljc":"Clojure",".cljs":"Clojure",".cljs.hl":"Clojure",".cljscm":"Clojure",".cljx":"Clojure",".hic":"Clojure",".coffee":"CoffeeScript","._coffee":"CoffeeScript",".cjsx":"CoffeeScript",".cson":"CoffeeScript",".iced":"CoffeeScript",".cfm":"ColdFusion",".cfml":"ColdFusion",".cfc":"ColdFusion CFC",".lisp":"NewLisp",".asd":"Common Lisp",".cl":"OpenCL",".l":"PicoLisp",".lsp":"NewLisp",".ny":"Common Lisp",".podsl":"Common Lisp",".sexp":"Common Lisp",".cps":"Component Pascal",".coq":"Coq",".v":"Verilog",".cr":"Crystal",".feature":"Cucumber",".cu":"Cuda",".cuh":"Cuda",".cy":"Cycript",".pyx":"Cython",".pxd":"Cython",".pxi":"Cython",".d":"Makefile",".di":"D",".com":"DIGITAL Command Language",".dm":"DM",".dart":"Dart",".djs":"Dogescript",".dylan":"Dylan",".dyl":"Dylan",".intr":"Dylan",".lid":"Dylan",".E":"E",".ecl":"ECLiPSe",".eclxml":"ECL",".e":"Eiffel",".ex":"Elixir",".exs":"Elixir",".elm":"Elm",".el":"Emacs Lisp",".emacs":"Emacs Lisp",".emacs.desktop":"Emacs Lisp",".em":"EmberScript",".emberscript":"EmberScript",".erl":"Erlang",".es":"JavaScript",".escript":"Erlang",".hrl":"Erlang",".xrl":"Erlang",".yrl":"Erlang",".fs":"GLSL",".fsi":"F#",".fsx":"F#",".fx":"HLSL",".flux":"FLUX",".f90":"FORTRAN",".f":"Forth",".f03":"FORTRAN",".f08":"FORTRAN",".f77":"FORTRAN",".f95":"FORTRAN",".for":"Forth",".fpp":"FORTRAN",".factor":"Factor",".fy":"Fancy",".fancypack":"Fancy",".fan":"Fantom",".fth":"Forth",".4th":"Forth",".forth":"Forth",".fr":"Frege",".frt":"Forth",".ftl":"FreeMarker",".gms":"GAMS",".g":"GAP",".gap":"GAP",".gd":"GDScript",".gi":"GAP",".tst":"Scilab",".s":"GAS",".ms":"MAXScript",".glsl":"GLSL",".fp":"GLSL",".frag":"JavaScript",".frg":"GLSL",".fsh":"GLSL",".fshader":"GLSL",".geo":"GLSL",".geom":"GLSL",".glslv":"GLSL",".gshader":"GLSL",".shader":"GLSL",".vert":"GLSL",".vrx":"GLSL",".vsh":"GLSL",".vshader":"GLSL",".gml":"Game Maker Language",".kid":"Genshi",".ebuild":"Gentoo Ebuild",".eclass":"Gentoo Eclass",".glf":"Glyph",".gp":"Gnuplot",".gnu":"Gnuplot",".gnuplot":"Gnuplot",".plot":"Gnuplot",".plt":"Gnuplot",".go":"Go",".golo":"Golo",".gs":"JavaScript",".gst":"Gosu",".gsx":"Gosu",".vark":"Gosu",".grace":"Grace",".gf":"Grammatical Framework",".groovy":"Groovy",".grt":"Groovy",".gtpl":"Groovy",".gvy":"Groovy",".gsp":"Groovy Server Pages",".hcl":"HCL",".tf":"HCL",".hlsl":"HLSL",".fxh":"HLSL",".hlsli":"HLSL",".php":"PHP",".hb":"Harbour",".hs":"Haskell",".hsc":"Haskell",".hx":"Haxe",".hxsl":"Haxe",".hy":"Hy",".pro":"QMake",".dlm":"IDL",".ipf":"IGOR Pro",".idr":"Idris",".lidr":"Idris",".ni":"Inform 7",".i7x":"Inform 7",".iss":"Inno Setup",".io":"Io",".ik":"Ioke",".thy":"Isabelle",".ijs":"J",".flex":"JFlex",".jflex":"JFlex",".jq":"JSONiq",".jsx":"JSX",".mdx":"MDX",".j":"Objective-J",".java":"Java",".jsp":"Java Server Pages",".js":"JavaScript","._js":"JavaScript",".bones":"JavaScript",".es6":"JavaScript",".jake":"JavaScript",".jsb":"JavaScript",".jscad":"JavaScript",".jsfl":"JavaScript",".jsm":"JavaScript",".jss":"JavaScript",".njs":"JavaScript",".pac":"JavaScript",".sjs":"JavaScript",".ssjs":"JavaScript",".sublime-build":"JavaScript",".sublime-commands":"JavaScript",".sublime-completions":"JavaScript",".sublime-keymap":"JavaScript",".sublime-macro":"JavaScript",".sublime-menu":"JavaScript",".sublime-mousemap":"JavaScript",".sublime-project":"JavaScript",".sublime-settings":"JavaScript",".sublime-theme":"JavaScript",".sublime-workspace":"JavaScript",".sublime_metrics":"JavaScript",".sublime_session":"JavaScript",".xsjs":"JavaScript",".xsjslib":"JavaScript",".jl":"Julia",".krl":"KRL",".sch":"KiCad",".brd":"KiCad",".kicad_pcb":"KiCad",".kt":"Kotlin",".ktm":"Kotlin",".kts":"Kotlin",".lfe":"LFE",".ll":"LLVM",".lol":"LOLCODE",".lsl":"LSL",".lslp":"LSL",".lvproj":"LabVIEW",".lasso":"Lasso",".las":"Lasso",".lasso8":"Lasso",".lasso9":"Lasso",".ldml":"Lasso",".lean":"Lean",".hlean":"Lean",".lex":"Lex",".ly":"LilyPond",".ily":"LilyPond",".m":"Objective-C",".lagda":"Literate Agda",".litcoffee":"Literate CoffeeScript",".lhs":"Literate Haskell",".ls":"LoomScript","._ls":"LiveScript",".xm":"Logos",".x":"Logos",".xi":"Logos",".lgt":"Logtalk",".logtalk":"Logtalk",".lookml":"LookML",".lua":"Lua",".fcgi":"Shell",".nse":"Lua",".pd_lua":"Lua",".rbxs":"Lua",".wlua":"Lua",".mumps":"M",".m4":"M4Sugar",".mcr":"MAXScript",".muf":"MUF",".mak":"Makefile",".mk":"Makefile",".mkfile":"Makefile",".mako":"Mako",".mao":"Mako",".mathematica":"Mathematica",".cdf":"Mathematica",".ma":"Mathematica",".mt":"Mathematica",".nb":"Mathematica",".nbp":"Mathematica",".wl":"Mathematica",".wlt":"Mathematica",".matlab":"Matlab",".maxpat":"Max",".maxhelp":"Max",".maxproj":"Max",".mxt":"Max",".pat":"Max",".moo":"Moocode",".metal":"Metal",".minid":"MiniD",".druby":"Mirah",".duby":"Mirah",".mir":"Mirah",".mirah":"Mirah",".mo":"Modelica",".mms":"Module Management System",".mmk":"Module Management System",".monkey":"Monkey",".moon":"MoonScript",".myt":"Myghty",".ncl":"NCL",".nsi":"NSIS",".nsh":"NSIS",".n":"Nemerle",".axs":"NetLinx",".axi":"NetLinx",".axs.erb":"NetLinx+ERB",".axi.erb":"NetLinx+ERB",".nlogo":"NetLogo",".nl":"NewLisp",".nim":"Nimrod",".nimrod":"Nimrod",".nit":"Nit",".nix":"Nix",".nu":"Nu",".numpy":"NumPy",".numpyw":"NumPy",".numsc":"NumPy",".ml":"OCaml",".eliom":"OCaml",".eliomi":"OCaml",".ml4":"OCaml",".mli":"OCaml",".mll":"OCaml",".mly":"OCaml",".mm":"Objective-C++",".sj":"Objective-J",".omgrofl":"Omgrofl",".opa":"Opa",".opal":"Opal",".opencl":"OpenCL",".p":"OpenEdge ABL",".scad":"OpenSCAD",".ox":"Ox",".oxh":"Ox",".oxo":"Ox",".oxygene":"Oxygene",".oz":"Oz",".pwn":"PAWN",".aw":"PHP",".ctp":"PHP",".php3":"PHP",".php4":"PHP",".php5":"PHP",".phps":"PHP",".phpt":"PHP",".pls":"PLSQL",".pck":"PLSQL",".pkb":"PLSQL",".pks":"PLSQL",".plb":"PLSQL",".plsql":"PLSQL",".sql":"SQLPL",".pov":"POV-Ray SDL",".pan":"Pan",".psc":"Papyrus",".parrot":"Parrot",".pasm":"Parrot Assembly",".pir":"Parrot Internal Representation",".pas":"Pascal",".dfm":"Pascal",".dpr":"Pascal",".lpr":"Pascal",".pp":"Puppet",".pl":"Prolog",".al":"Perl",".cgi":"Shell",".perl":"Perl",".ph":"Perl",".plx":"Perl",".pm":"Perl6",".pod":"Perl",".psgi":"Perl",".t":"Turing",".6pl":"Perl6",".6pm":"Perl6",".nqp":"Perl6",".p6":"Perl6",".p6l":"Perl6",".p6m":"Perl6",".pl6":"Perl6",".pm6":"Perl6",".pig":"PigLatin",".pike":"Pike",".pmod":"Pike",".pogo":"PogoScript",".pony":"Pony",".ps1":"PowerShell",".psd1":"PowerShell",".psm1":"PowerShell",".pde":"Processing",".prolog":"Prolog",".yap":"Prolog",".spin":"Propeller Spin",".pd":"Pure Data",".pb":"PureBasic",".pbi":"PureBasic",".purs":"PureScript",".py":"Python",".bzl":"Python",".gyp":"Python",".lmi":"Python",".pyde":"Python",".pyp":"Python",".pyt":"Python",".pyw":"Python",".rpy":"Ren'Py",".tac":"Python",".wsgi":"Python",".xpy":"Python",".qml":"QML",".qbs":"QML",".pri":"QMake",".r":"Rebol",".rd":"R",".rsx":"R",".rbbas":"REALbasic",".rbfrm":"REALbasic",".rbmnu":"REALbasic",".rbres":"REALbasic",".rbtbar":"REALbasic",".rbuistate":"REALbasic",".rkt":"Racket",".rktd":"Racket",".rktl":"Racket",".scrbl":"Racket",".rl":"Ragel in Ruby Host",".reb":"Rebol",".r2":"Rebol",".r3":"Rebol",".rebol":"Rebol",".red":"Red",".reds":"Red",".cw":"Redcode",".rs":"Rust",".rsh":"RenderScript",".robot":"RobotFramework",".rg":"Rouge",".rb":"Ruby",".builder":"Ruby",".gemspec":"Ruby",".god":"Ruby",".irbrc":"Ruby",".jbuilder":"Ruby",".mspec":"Ruby",".pluginspec":"Ruby",".podspec":"Ruby",".rabl":"Ruby",".rake":"Ruby",".rbuild":"Ruby",".rbw":"Ruby",".rbx":"Ruby",".ru":"Ruby",".ruby":"Ruby",".thor":"Ruby",".watchr":"Ruby",".rs.in":"Rust",".sas":"SAS",".smt2":"SMT",".smt":"SMT",".sqf":"SQF",".hqf":"SQF",".db2":"SQLPL",".sage":"Sage",".sagews":"Sage",".sls":"Scheme",".scala":"Scala",".sbt":"Scala",".sc":"SuperCollider",".scm":"Scheme",".sld":"Scheme",".sps":"Scheme",".ss":"Scheme",".sci":"Scilab",".sce":"Scilab",".self":"Self",".sh":"Shell",".bash":"Shell",".bats":"Shell",".command":"Shell",".ksh":"Shell",".sh.in":"Shell",".tmux":"Shell",".tool":"Shell",".zsh":"Shell",".sh-session":"ShellSession",".shen":"Shen",".sl":"Slash",".smali":"Smali",".st":"Smalltalk",".tpl":"Smarty",".sp":"SourcePawn",".sma":"SourcePawn",".nut":"Squirrel",".stan":"Stan",".ML":"Standard ML",".fun":"Standard ML",".sig":"Standard ML",".sml":"Standard ML",".do":"Stata",".ado":"Stata",".doh":"Stata",".ihlp":"Stata",".mata":"Stata",".matah":"Stata",".sthlp":"Stata",".scd":"SuperCollider",".swift":"Swift",".sv":"SystemVerilog",".svh":"SystemVerilog",".vh":"SystemVerilog",".txl":"TXL",".tcl":"Tcl",".adp":"Tcl",".tm":"Tcl",".tcsh":"Tcsh",".csh":"Tcsh",".thrift":"Thrift",".tu":"Turing",".ts":"TypeScript",".tsx":"TypeScript",".upc":"Unified Parallel C",".uno":"Uno",".uc":"UnrealScript",".ur":"UrWeb",".urs":"UrWeb",".vcl":"VCL",".vhdl":"VHDL",".vhd":"VHDL",".vhf":"VHDL",".vhi":"VHDL",".vho":"VHDL",".vhs":"VHDL",".vht":"VHDL",".vhw":"VHDL",".vala":"Vala",".vapi":"Vala",".veo":"Verilog",".vim":"VimL",".vb":"Visual Basic",".bas":"Visual Basic",".frm":"Visual Basic",".frx":"Visual Basic",".vba":"Visual Basic",".vbhtml":"Visual Basic",".vbs":"Visual Basic",".volt":"Volt",".webidl":"WebIDL",".x10":"X10",".xc":"XC",".xsp-config":"XPages",".xsp.metadata":"XPages",".xpl":"XProc",".xproc":"XProc",".xquery":"XQuery",".xq":"XQuery",".xql":"XQuery",".xqm":"XQuery",".xqy":"XQuery",".xs":"XS",".xslt":"XSLT",".xsl":"XSLT",".xojo_code":"Xojo",".xojo_menu":"Xojo",".xojo_report":"Xojo",".xojo_script":"Xojo",".xojo_toolbar":"Xojo",".xojo_window":"Xojo",".xtend":"Xtend",".y":"Yacc",".yacc":"Yacc",".yy":"Yacc",".zep":"Zephir",".zimpl":"Zimpl",".zmpl":"Zimpl",".zpl":"Zimpl",".ec":"eC",".eh":"eC",".fish":"fish",".mu":"mupad",".nc":"nesC",".ooc":"ooc",".wisp":"wisp",".prg":"xBase",".prw":"xBase"},Io=[...rr,...Object.keys(Oi)],P={MAX_DOC_SIZE:10*1024*1024,ACCEPTED_MIME_TYPES:["text/plain","application/pdf","text/markdown","text/csv","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],DOC_TYPES:rr,EMBEDDING_MODEL:"text-embedding-3-large",EMBEDDING_DIMENSIONS:256,MIN_CHUNK_LENGTH:1024,MAX_CHUNK_LENGTH:3e4,MIN_CHUNK_OVERLAP:256,EMBEDDING_MODEL_TOKENS_LIMIT:8191,EMBEDDING_MAX_BATCH_SIZE:2048,EMBEDDING_ENCODING_FORMAT:"float",TOP_K:3,MAX_CHUNKS_ATTACHED_TO_LLM:20,OLLAMA_EMBEDDINGS_ENDPOINT:"http://localhost:11434/api/embeddings",OLLAMA_EMBEDDINGS_MODEL:"mxbai-embed-large"},eo=`Below is some CONTEXT for you to answer the questions. ONLY answer from the CONTEXT. CONTEXT consists of multiple information chunks. Each chunk has a source mentioned at the end.

For each piece of response you provide, cite the source in brackets like so: [1].

At the end of the answer, always list each source with its corresponding number and provide the document name. like so [1] Filename.doc.

If you don't know the answer, just say that you don't know. Ask for more context and better questions if needed.`;import*as Q from"@clack/prompts";import Te from"fs/promises";import _e from"path";import{getDocumentProxy as $i,extractText as Di}from"unpdf";import*as To from"xlsx";async function lt(e){let o=e.type;o.includes("charset")&&(o="text/plain");let t="";return o==="text/plain"?t=await Li(e):o==="application/pdf"?t=await Ni(e):o==="text/csv"?t=await Fi(e):o.includes("application/vnd")?t=await ji(e):t=await Gi(e),t=Bi(t),t}async function Li(e){return await e.text()}async function Ni(e){let o=await $i(await e.arrayBuffer()),{text:t}=await Di(o,{mergePages:!0});return typeof t=="string"?t:t.join(`
`)}async function Fi(e){let o=await e.text();return nr(o)}async function ji(e){let o=await e.arrayBuffer(),t=To.read(new Uint8Array(o),{type:"array"}),r="";for(let n of t.SheetNames){let s=t.Sheets[n],i=To.utils.sheet_to_csv(s),a=nr(i);r+=a+`

`}return r}async function Gi(e){return await e.text()}function Bi(e){return e.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDFFF]|[\u2011-\u26FF]|\uD83E[\uDD10-\uDDFF])/g,"")}function nr(e){let o=e.split(`
`),t=o[0].replace("\r","");return o.slice(1).map(n=>n.trim()===""||/^[,]+$/.test(n.trim())?"":t+`
`+n).join(`

`)}import*as gt from"@clack/prompts";import{fromZodError as Cr}from"zod-validation-error";import*as sr from"@clack/prompts";import qi from"compute-cosine-similarity";import _o from"fs/promises";import{Low as ir}from"lowdb";import{JSONFile as ar}from"lowdb/node";import mt from"path";import Ui from"picocolors";import{z as oo}from"zod";var Hi=oo.object({id:oo.string().uuid(),text:oo.string().trim().min(1),embedding:oo.array(oo.number())}),ko={documents:{},chunks:{}};async function ct(e){let o=mt.join(process.cwd(),".baseai","db"),t=mt.join(o,`${e}.json`);await _o.mkdir(o,{recursive:!0});try{await _o.access(t)}catch{await _o.writeFile(t,JSON.stringify(ko,null,2))}let r=new ar(t),n=new ir(r,ko);return await n.read(),n.data===null&&(n.data=ko,await n.write()),n}async function Ji(e){let o=new ar(e),t=new ir(o,ko);return await t.read(),t}async function Fe(e){try{let o=Ki(e);return await _o.access(o),await Ji(o)}catch(o){if(o.code==="ENOENT")return await ct(e);throw o}}async function pr({db:e,docName:o}){if(e.data.documents[o]){sr.log.info(`[SKIPPED] DOC: ${Ui.cyan(o)} already exists.`);return}e.data.documents[o]={name:o,chunkIds:[]},await e.write()}function lr(e,o){return e.data.documents[o]}async function Ro({db:e,docName:o}){if(!e.data.documents[o])throw new Error(`Document with name "${o}" does not exist`);for(let t of e.data.documents[o].chunkIds)delete e.data.chunks[t];delete e.data.documents[o],await e.write()}async function mr({db:e,docName:o,chunks:t}){if(!e.data.documents[o])throw new Error(`Document with name "${o}" does not exist`);for(let r of t){let n=crypto.randomUUID(),s=Hi.parse({...r,id:n});e.data.chunks[n]=s,e.data.documents[o].chunkIds.push(n)}await e.write()}async function Oo(e){let o=[];for(let t of e){let r=await Fe(t);for(let[n,s]of Object.entries(r.data.documents)){let i=s.chunkIds.map(a=>{let p=r.data.chunks[a];return{text:p.text,embedding:p.embedding,attributes:{memoryName:t,docName:n}}});o.push(...i)}}return o}function $o({chunks:e,queryEmbedding:o,topK:t}){if(t<=0||e.length===0)return[];let r=e.map(n=>({text:n.text,attributes:n.attributes,similarity:qi(n.embedding,o)||0}));return r.sort((n,s)=>s.similarity-n.similarity),r.slice(0,t)}function Ki(e){let o=process.cwd();return mt.join(o,".baseai","db",`${e}.json`)}import{z as M}from"zod";var to=M.string().min(3,"Memory name must be at least 3 characters long").max(50,"Memory name must not exceed 50 characters").regex(/^[a-zA-Z0-9.-]+$/,"Memory name can only contain letters, numbers, dots, and hyphens"),Vi=M.string().trim().min(1),cr=M.object({memoryName:to,documentName:Vi}),zi=M.object({enabled:M.boolean(),include:M.array(M.string().trim().min(1,"Include pattern must not be empty")).min(1,"At least one include pattern must be specified").describe("Glob patterns to include files in the memory"),gitignore:M.boolean().optional().default(!0),deployedAt:M.string().trim().optional().default(""),embeddedAt:M.string().trim().optional().default("")}),Xi=M.object({meta:M.function().args(M.object({name:M.string(),size:M.string(),content:M.string(),blob:M.instanceof(Blob),path:M.string()})).returns(M.record(M.string())).optional()}),Do=M.object({name:M.string(),description:M.string().optional(),git:zi,documents:Xi.optional()});import*as ur from"@clack/prompts";import je from"chalk";import Yi from"util";import Wi from"log-symbols";var Qi=je.blue.inverse,Zi=["sensitive","secret","hide","private","password","token","key","auth","authorization","redact"],dt=class e{constructor(o){this.config=o}static async initialize(){if(!e.instance){let o=await W();e.instance=new e(o.log)}return e.instance}formatValue(o){return typeof o=="object"&&o!==null?Yi.inspect(o,{colors:!0,depth:null}):typeof o=="string"?je.green(`"${o}"`):typeof o=="number"?je.yellow(o.toString()):typeof o=="boolean"?je.cyan(o.toString()):String(o)}isSensitiveData(o){return Zi.some(t=>o.toLowerCase().includes(t))}formatAndRedactSensitiveData(o,t){return t&&!this.config.logSensitiveData?je.red("======REDACTED======"):this.formatValue(o)}isCategoryEnabled(o){let t=o.split("."),r="";for(let n of t)if(r+=(r?".":"")+n,r in this.config){let s=this.config[r];if(typeof s=="boolean"&&s===!1)return!1}return!0}logValue(o,t,r){let n=this.formatAndRedactSensitiveData(t,this.isSensitiveData(r||o)),s=r?`${je.blue.bold(r)}`:"";console.log(`
${Wi.info} ${Qi(` ${o} `)} ${s}
${n}`)}log(o,t,r){!this.config.isEnabled||!this.isCategoryEnabled(o)||this.logValue(o,t,r)}},dr=dt;var ft=null,ut=null,fr=async()=>{ut||(ut=dr.initialize()),ft=await ut},ea=()=>(ft||(ur.cancel("Logger has not been initialized. Call initLogger() first."),process.exit(1)),ft),ge=(e,o,t)=>{ea().log(e,o,t)};import*as hr from"@clack/prompts";async function Ge(e){try{return await gr("test"),(await Promise.all(e.map(n=>gr(n)))).map(n=>n.embedding).map(n=>({embedding:n}))}catch(o){throw console.error("Error generating embeddings:",o),o}}async function gr(e){let o=P.OLLAMA_EMBEDDINGS_ENDPOINT,t=JSON.stringify({model:P.OLLAMA_EMBEDDINGS_MODEL,prompt:e});try{let r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:t});if(!r.ok)throw new Error(`Error: ${r.statusText}`);return await r.json()}catch(r){throw console.error(),hr.cancel(`Error generating embeddings with Ollama. Please ensure that Ollama is running and the embeddings '${P.OLLAMA_EMBEDDINGS_MODEL}' model is enabled.`),process.exit(1),r}}import*as yr from"@clack/prompts";import{getEncoding as oa}from"js-tiktoken";import ta from"openai";var Be=async e=>{let o=process.env.OPENAI_API_KEY;o||(yr.cancel("OpenAI key not found. Please set the OPENAI_API_KEY environment variable. Only required locally, in production, add it to your keysets https://langbase.com/docs/features/keysets"),process.exit(1));try{let t=new ta({apiKey:o}),r=oa("cl100k_base"),n=0;for(let a of e){let p=r.encode(a).length;if(n+=p,p>P.EMBEDDING_MODEL_TOKENS_LIMIT)throw new Error(`Input exceeds the maximum token limit of ${P.EMBEDDING_MODEL_TOKENS_LIMIT}.`)}let s=[],i=P.EMBEDDING_MAX_BATCH_SIZE;for(let a=0;a<e.length;a+=i){let p=e.slice(a,a+i),{data:l}=await t.embeddings.create({model:P.EMBEDDING_MODEL,dimensions:P.EMBEDDING_DIMENSIONS,input:p,encoding_format:P.EMBEDDING_ENCODING_FORMAT});s.push(...l)}return s}catch(t){throw console.error("Error:",t),new Error("Error getting OpenAI embeddings")}};function ro(e){return e===0?"0 bytes":e<1024?e.toFixed(2)+" bytes":e<1024*1024?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB"}var Lo=e=>{let o=to.safeParse(e);if(!o.success){let t=Cr(o.error).message;gt.cancel(`Invalid memory name: ${t}`),process.exit(1)}return o.data},br=({memoryName:e,documentName:o})=>{let t=cr.safeParse({memoryName:e,documentName:o});if(!t.success){let r=Cr(t.error).message;gt.cancel(`Invalid input: ${r}`),process.exit(1)}return t.data};var xr=async({messages:e,memoryNames:o})=>{var t;try{let r=o.length>0;ge("memory",r,"Memory attached");let n=e.length>0;if(!r||!n)return;let s=[...e].reverse().find(d=>d.role==="user"),i=s==null?void 0:s.content;if(!i)return;let p=((t=(await W()).memory)==null?void 0:t.useLocalEmbeddings)||!1,l=[];p?(u("Generating local embeddings"),l=await Ge([i])):(u("Generating OpenAI embeddings"),l=await Be([i]));let m=await Oo(o);if(m.length===0)return;let c=$o({chunks:m,queryEmbedding:l[0].embedding,topK:P.MAX_CHUNKS_ATTACHED_TO_LLM});return c.length===0?void 0:(ge("memory.similarChunks",c),c)}catch(r){u("utils/memory/lib.ts: addContextFromMemory: error:",r)}};import wr from"fs/promises";import Pr from"path";import*as qe from"@clack/prompts";function ra(e){return typeof e=="object"&&e!==null&&"useGitRepo"in e&&typeof e.useGitRepo=="boolean"&&"dirToTrack"in e&&typeof e.dirToTrack=="string"&&"extToTrack"in e&&Array.isArray(e.extToTrack)}function No(e){if(typeof e!="object"||e===null||!("name"in e)||!("config"in e))return!1;let o=e;return typeof o.name=="string"&&(o.config===void 0||ra(o.config))}function Fo(e){if(!e.config)return"Invalid memory config.";let o={name:e.name,description:e.description||"Your memory description",git:{enabled:e.config.useGitRepo,include:e.config.extToTrack[0]==="*"?[`${e.config.dirToTrack}/**/*`]:e.config.extToTrack.map(t=>{var r;return`${(r=e.config)==null?void 0:r.dirToTrack}/**/*${t}`}),gitignore:!0,deployedAt:e.config.deployedCommitHash||"",embeddedAt:e.config.embeddedCommitHash||""}};return`
Your memory config is using an outdated format in baseai/memory/${e.name}/index.ts. Please update the file to this new format:

${JSON.stringify(o,null,2)}

Key changes:
- Removed nested 'config' object structure
- Git-related fields are now grouped under a 'git' object
- 'useGitRepo' is now 'git.enabled'
- 'dirToTrack' and 'extToTrack' are combined into 'git.include' glob patterns
- 'deployedCommitHash' is now 'git.deployedAt'
- 'embeddedCommitHash' is now 'git.embeddedAt'
- Added new 'git.gitignore' field (defaults to true)

For more information, refer to the documentation: https://baseai.dev/docs/guides/memory-from-git
`}function na(e){try{let o=e.replace(/import\s+.*?['"];?\s*/g,"").replace(/export\s+default\s+/,""),t=o.match(/(?:const\s+)?(\w+)\s*=\s*\(\s*\)\s*(?::\s*\w+)?\s*=>\s*\(({[\s\S]*?})\)/);if(t||(t=o.match(/(?:const\s+)?(\w+)\s*=\s*\(\s*\)\s*(?::\s*\w+)?\s*=>\s*\{[\s\S]*?return\s+({[\s\S]*?})\s*;\s*\}/)),t||(t=o.match(/(?:const\s+)?(?:memory|\w+)\s*=\s*({[\s\S]*?});?$/m)),!t)throw new Error("Unable to find memory object definition");let r=t[t.length-1];return new Function(`return ${r}`)()}catch(o){throw console.error("Parsing error:",o),console.error("File contents:",e),new Error(`Failed to extract config: ${o instanceof Error?o.message:"Unknown error"}`)}}async function no(e){try{let o=Pr.join(process.cwd(),"baseai","memory",e),t=Pr.join(o,"index.ts");await wr.access(t);let r=await wr.readFile(t,"utf-8"),n=na(r);try{return Do.parse(n)}catch(s){throw n&&No(n)&&(qe.note(Fo(n)),qe.cancel("Deployment cancelled. Please update your memory config file to the new format."),process.exit(1)),s}}catch(o){o instanceof Error?qe.cancel(`Failed to load memory '${e}': ${o.message}`):qe.cancel(`Failed to load memory '${e}': Unknown error`),process.exit(1)}}import{execSync as ht}from"child_process";import sa from"fast-glob";var Pe=async e=>{let o=await aa(e),t=!o||!o.git.enabled,r=o==null?void 0:o.documents;return t?await ia({memoryName:e,documentConfig:r}):await yt({memoryName:e,memoryConfig:o})},yt=async({memoryName:e,memoryConfig:o})=>{let t=o.git.include;(!Array.isArray(t)||t.length===0)&&(Q.cancel(`No include patterns specified for memory '${e}'`),process.exit(1)),console.log("Reading documents in memory...");let r;try{let i=new Set([...ht("git ls-files",{encoding:"utf-8"}).split(`
`).filter(Boolean),...ht("git ls-files --others --exclude-standard",{encoding:"utf-8"}).split(`
`).filter(Boolean),...ht("git diff --name-only",{encoding:"utf-8"}).split(`
`).filter(Boolean)]);r=(await sa(t,{ignore:["node_modules/**"],dot:!0,gitignore:o.git.gitignore||!0})).filter(p=>i.has(p))}catch{Q.cancel(`Failed to read documents in memory '${e}'.`),process.exit(1)}let s=(await Promise.all(r.map(async i=>{var f;if(!Io.some(b=>i.endsWith(b)))return null;let p;try{p=await Te.readFile(i)}catch{return Q.log.warn(`Failed to read file: ${i}. Skipping.`),null}let l=new Blob([p]);if(l.size>P.MAX_DOC_SIZE)return Q.log.warn(`Skipping ${i}; File exceeds the maximum size of ${ro(P.MAX_DOC_SIZE)}.`),null;let c={path:i,name:_e.basename(i.replace(/\//g,"-")),size:ro(l.size),content:await lt(l),blob:l},d={};return(f=o==null?void 0:o.documents)!=null&&f.meta&&(d=o.documents.meta(c)||{}),{...c,meta:d}}))).filter(i=>i!==null);return s.length===0?[]:s},ia=async({memoryName:e,documentConfig:o})=>{let t=_e.join(process.cwd(),"baseai","memory",e),r=_e.join(t,"documents");try{await Te.access(r)}catch{Q.cancel(`Documents directory for memory '${e}' does not exist.`),process.exit(1)}let n;try{n=await Te.readdir(r)}catch{Q.cancel(`Failed to read documents in memory '${e}'.`),process.exit(1)}let i=(await Promise.all(n.map(async a=>{if(!Io.some(x=>a.endsWith(x)))return Q.log.warn(`Skipping ${a}; Unsupported file extension.`),null;let l=_e.join(r,a),m;try{m=await Te.readFile(l)}catch{return Q.log.warn(`Failed to read file: ${a}. Skipping.`),null}let c=new Blob([m]);if(c.size>P.MAX_DOC_SIZE)return Q.log.warn(`Skipping ${a}; File exceeds the maximum size of ${ro(P.MAX_DOC_SIZE)}.`),null;let f={name:a,path:l,size:ro(c.size),content:await lt(c),blob:c},b={};return o!=null&&o.meta&&(b=o.meta(f)||{}),{...f,meta:b}}))).filter(a=>a!==null);return i.length===0?[]:i};async function aa(e){let o=await no(e);return o!==null?(Do.safeParse(o).success||(Q.cancel(`Memory '${e}' has an invalid config.`),process.exit(1)),{...o}):null}var jo=async e=>{let o=_e.join(process.cwd(),"baseai","memory",e),t=_e.join(o,"documents");try{await Te.access(t)}catch{Q.cancel(`Documents directory for memory '${e}' does not exist.`),process.exit(1)}try{let r=await Te.readdir(t);return(await Promise.all(r.map(async s=>{let i=_e.join(t,s),a=await Te.stat(i),p=Io.some(m=>s.endsWith(m)),l=a.size<=P.MAX_DOC_SIZE;return p&&l?s:null}))).filter(s=>s!==null)}catch{Q.cancel(`Failed to read documents in memory '${e}'.`),process.exit(1)}};import vr from"chalk";import pa from"cli-table3";import*as Ct from"@clack/prompts";function Er(e,o){let t=new Set([...e,...o]),r=Array.from(t).map(s=>[e.includes(s)?s:"",o.includes(s)?s:""]),n=new pa({head:[vr.cyan("Local"),vr.cyan("Prod")],chars:{top:"\u2550","top-mid":"\u2564","top-left":"\u2554","top-right":"\u2557",bottom:"\u2550","bottom-mid":"\u2567","bottom-left":"\u255A","bottom-right":"\u255D",left:"\u2551","left-mid":"\u255F",mid:"\u2500","mid-mid":"\u253C",right:"\u2551","right-mid":"\u2562",middle:"\u2502"}});r.forEach(s=>n.push(s)),Ct.log.message("Prod and local are out of sync."),Ct.log.message(`
${n.toString()}`)}import*as g from"@clack/prompts";import mo from"fs/promises";import ke from"node-fetch";import me from"path";import fa from"picocolors";import{execSync as xt}from"child_process";import*as le from"@clack/prompts";import Sr from"fs/promises";import*as so from"@clack/prompts";import Mr from"path";async function Ar({memoryName:e,deployedCommitHash:o}){try{let t=Mr.join(process.cwd(),"baseai","memory",e),r=Mr.join(t,"index.ts"),n=await Sr.readFile(r,"utf-8");if(n.includes("git:")){let s=n.match(/(\t*)git:\s*{[^}]*?}/);if(s){let[i,a]=s,p=a+"	",l=i.match(/{\s*\n?\s*(.*?)\s*\n?\s*}/s),m=l?l[1]:"",c=m.split(`
`).map(f=>f.trim().replace(/,\s*$/,"")).filter(Boolean),d;m.includes("deployedAt:")?c=c.map(f=>f.includes("deployedAt:")?`deployedAt: '${o}'`:f):c.push(`deployedAt: '${o}'`),d=c.map((f,b)=>{let x=b===c.length-1;return`${p}${f}${x?"":","}`}).join(`
`),n=n.replace(/(\t*)git:\s*{[^}]*?}/,`${a}git: {
${d}
${a}}`)}}else{let s=n.match(/(?:const\s+\w+\s*=\s*\(\s*\)\s*(?::\s*\w+)?\s*=>\s*\({[\s\S]*?)(}\))/);if(s){let i=s.index+s[0].length-s[1].length,a=n.slice(0,i),p=n.slice(i),l=a.match(/\n(\t+)[^\n]+\n\s*$/),m=l?l[1]:"	",c=m+"	",d=["enabled: false","include: ['**/*']","gitignore: false",`deployedAt: '${o}'`],f=d.map((b,x)=>{let fe=x===d.length-1;return`${c}${b}${fe?"":","}`}).join(`
`);n=`${a},
${m}git: {
${f}
${m}}${p}`}else throw new Error("Could not find appropriate location to insert git config")}await Sr.writeFile(r,n,"utf-8"),so.log.success(`Updated deployedAt hash for memory '${e}'.`)}catch(t){throw t instanceof Error?so.cancel(`Failed to save deployedAt hash for memory '${e}': ${t.message}`):so.cancel(`Failed to save deployedAt hash for memory '${e}': Unknown error`),t}}import{execSync as Ir}from"child_process";async function _r({oldCommit:e,latestCommit:o="HEAD",include:t}){try{if(e==="")throw new Error("Invalid commit references");if(!Array.isArray(t)||t.length===0)throw new Error("Include patterns must be a non-empty array");let r=process.cwd(),n=Ir(Tr({include:t,oldCommit:e,diffFilter:"ACMRT",latestCommit:o}),{encoding:"utf-8",cwd:r}).trim(),s=Ir(Tr({include:t,oldCommit:e,diffFilter:"D",latestCommit:o}),{encoding:"utf-8",cwd:r}).trim(),i=n?n.split(`
`).filter(Boolean).map(p=>p.replace(/\//g,"-")):[],a=s?s.split(`
`).filter(Boolean).map(p=>p.replace(/\//g,"-")):[];return{changedFiles:i,deletedFiles:a}}catch(r){throw console.error("Error executing Git command:",r),r}}var Tr=({include:e,oldCommit:o,diffFilter:t,latestCommit:r})=>{let n=`git diff --diff-filter=${t} --name-only ${o} ${r}`;if(e.length===1)return`${n} -- "${e[0]}"`;let s=e.map(i=>`"${i}"`).join(" ");return`${n} -- ${s}`};import*as Z from"@clack/prompts";import Ue from"figures";import he from"picocolors";var bt=class{constructor(o){if(this.chunkSize=o.chunkMaxLength,this.chunkOverlap=o.chunkOverlap,this.keepSeparator=!0,this.lengthFunction=t=>t.length,this.chunkOverlap>=this.chunkSize)throw new Error("Cannot have chunkOverlap >= chunkSize")}async splitText(o){throw new Error("splitText method must be implemented in subclass")}async mergeSplits(o,t){let r=[],n=[],s=0;for(let a of o){let p=await this.lengthFunction(a);if(s+p+(n.length>0?t.length:0)>this.chunkSize&&(s>this.chunkSize&&console.warn(`Created a chunk of size ${s}, which is longer than the specified ${this.chunkSize}`),n.length>0)){let l=this.joinDocs(n,t);for(l!==null&&r.push(l);s>this.chunkOverlap||s+p>this.chunkSize&&s>0;)s-=await this.lengthFunction(n[0]),n.shift()}n.push(a),s+=p}let i=this.joinDocs(n,t);return i!==null&&r.push(i),r}joinDocs(o,t){let r=o.join(t).trim();return r===""?null:r}async createChunks(o){return(await this.splitText(o)).map(r=>r.replace(/\0/g,""))}},Go=class e extends bt{constructor(t,r){super(t);this.separators=[`

`,`
`," ",""];r&&(this.separators=r)}async splitText(t){return this._splitText(t,this.separators)}async _splitText(t,r){let n=[],s=r[r.length-1],i;for(let m=0;m<r.length;m+=1){let c=r[m];if(c===""){s=c;break}if(t.includes(c)){s=c,i=r.slice(m+1);break}}let a=this.splitOnSeparator(t,s),p=[],l=this.keepSeparator?"":s;for(let m of a)if(await this.lengthFunction(m)<this.chunkSize)p.push(m);else{if(p.length){let c=await this.mergeSplits(p,l);n.push(...c),p=[]}if(!i)n.push(m);else{let c=await this._splitText(m,i);n.push(...c)}}if(p.length){let m=await this.mergeSplits(p,l);n.push(...m)}return n}splitOnSeparator(t,r){let n;if(r)if(this.keepSeparator){let s=r.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&");n=t.split(new RegExp(`(?=${s})`))}else n=t.split(r);else n=t.split("");return n.filter(s=>s!=="")}static fromLanguage(t,r){let n=e.getSeparatorsForLanguage(t);return new e(r,n)}static getSeparatorsForLanguage(t){throw new Error("getSeparatorsForLanguage method not implemented")}};async function Bo({memoryFiles:e,memoryName:o,overwrite:t=!1,useLocalEmbeddings:r}){var c;let n,s=0,i=e.length,a=0,p=0,l=0;try{n=await Fe(o)}catch{Z.cancel(`Failed to load database for memory '${o}'.`),process.exit(1)}let m=new Go({chunkMaxLength:P.MIN_CHUNK_LENGTH,chunkOverlap:P.MIN_CHUNK_OVERLAP});for(let{name:d,content:f}of e){let b=lr(n,d);if(b&&t&&(Z.log.info(`Removing existing embeddings for DOC: ${he.cyan(d)}`),await Ro({db:n,docName:d})),b&&!t){Z.log.info(`[SKIPPED] DOC: ${he.cyan(d)} already exists.`),p++;continue}Z.log.info(`Embedding document: ${d}`);try{pr({db:n,docName:d});let x;try{x=await m.createChunks(f)}catch{Z.log.error(`Failed to split document "${d}" into chunks. Skipping.`),l++;continue}let fe;try{let ae=((c=(await W()).memory)==null?void 0:c.useLocalEmbeddings)||!1;r??ae?(u("Generating local embeddings"),fe=await Ge(x)):(u("Generating OpenAI embeddings"),fe=await Be(x))}catch(S){Z.cancel(S.message),Z.log.error(`Failed to generate embeddings for document "${d}". Skipping.`),l++;continue}let Ye=x.map((S,ae)=>({text:S,embedding:fe[ae].embedding}));try{await mr({db:n,docName:d,chunks:Ye}),s+=Ye.length,a++,Z.log.success(`Successfully embedded document: ${d}`)}catch{Z.log.error(`Failed to add chunks for document "${d}" to the database. Skipping.`),l++}}catch{Z.log.error(`An unexpected error occurred while processing document "${d}". Skipping.`),l++}}return la({totalDocs:i,successfulDocs:a,skippedDocs:p,totalEmbeddings:s}),a===0&&p===0&&(Z.cancel("No documents were successfully embedded or skipped. Process failed."),process.exit(1)),a===0&&p===i?`All documents were skipped. No new embeddings were generated. 
${he.dim(`${Ue.arrowRight} Use --overwrite, -o flag to replace existing embeddings.`)}`:"All done!"}function la({totalDocs:e,successfulDocs:o,skippedDocs:t,totalEmbeddings:r}){let n=e-o-t,s=27,i=(p,l,m,c)=>{let d=p.padEnd(s);return`${m} ${d} ${c(l)}`},a=[he.bold(he.cyan("Embedding Generation Summary:")),"",i("Total documents:",`${e}`,Ue.info,he.blue),...t>0?[i("Skipped:",`${t}/${e} docs`,Ue.warning,he.yellow)]:[],i("Successfully embedded:",`${o}/${e} docs`,Ue.tick,he.green),...n>0?[i("Failed:",`${n}/${e} docs`,Ue.cross,he.red)]:[],i("Total embeddings generated:",`${r}`,Ue.pointer,he.magenta),""].join(`
`);Z.log.info(a)}async function kr({memoryName:e}){let o=await Fe(e);return Object.keys(o.data.documents)}import Rr from"fs/promises";import*as io from"@clack/prompts";import Or from"path";async function $r({memoryName:e,embeddedCommitHash:o}){try{let t=Or.join(process.cwd(),"baseai","memory",e),r=Or.join(t,"index.ts"),n=await Rr.readFile(r,"utf-8");if(n.includes("git:")){let s=n.match(/(\t*)git:\s*{[^}]*?}/);if(s){let[i,a]=s,p=a+"	",l=i.match(/{\s*\n?\s*(.*?)\s*\n?\s*}/s),m=l?l[1]:"",c=m.split(`
`).map(f=>f.trim().replace(/,\s*$/,"")).filter(Boolean),d;m.includes("embeddedAt:")?c=c.map(f=>f.includes("embeddedAt:")?`embeddedAt: '${o}'`:f):c.push(`embeddedAt: '${o}'`),d=c.map((f,b)=>{let x=b===c.length-1;return`${p}${f}${x?"":","}`}).join(`
`),n=n.replace(/(\t*)git:\s*{[^}]*?}/,`${a}git: {
${d}
${a}}`)}}else{let s=n.match(/(?:const\s+\w+\s*=\s*\(\s*\)\s*(?::\s*\w+)?\s*=>\s*\({[\s\S]*?)(}\))/);if(s){let i=s.index+s[0].length-s[1].length,a=n.slice(0,i),p=n.slice(i),l=a.match(/\n(\t+)[^\n]+\n\s*$/),m=l?l[1]:"	",c=m+"	",d=["enabled: false","include: ['**/*']","gitignore: false",`embeddedAt: '${o}'`],f=d.map((b,x)=>{let fe=x===d.length-1;return`${c}${b}${fe?"":","}`}).join(`
`);n=`${a},
${m}git: {
${f}
${m}}${p}`}else throw new Error("Could not find appropriate location to insert git config")}await Rr.writeFile(r,n,"utf-8"),io.log.success(`Updated embeddedAt hash for memory '${e}'.`)}catch(t){throw t instanceof Error?io.cancel(`Failed to save embeddedAt hash for memory '${e}': ${t.message}`):io.cancel(`Failed to save embeddedAt hash for memory '${e}': Unknown error`),t}}async function qo({memoryName:e,config:o,account:t}){var c,d;let r=!t;try{xt("git status --porcelain").toString().trim()&&(le.log.error(`There are uncommitted changes in the Git repository for ${r?"embedding":"deploying"} git-synced memory "${e}".`),le.log.info(`Please commit these changes before ${r?"embedding":"deploying"}. Aborting.`),process.exit(1))}catch(f){le.log.error(`Failed to check if there are uncommitted changes: ${f}`),process.exit(1)}let n=[],s=[],i=r?await kr({memoryName:e}):await ao({account:t,memoryName:e}),p=(await yt({memoryName:e,memoryConfig:o})).map(f=>f.name),l=p.filter(f=>!i.some(b=>b===f)),m=r?(c=o.git)==null?void 0:c.embeddedAt:(d=o.git)==null?void 0:d.deployedAt;if(!m)n=p,le.log.info(`Found no previous ${r?"deployed":"embedded"} commit. ${r?"Deploying":"Embedding"} all ${n.length} files in memory "${e}":`);else{let{changedFiles:f,deletedFiles:b}=await _r({oldCommit:m,latestCommit:"HEAD",include:o.git.include});if(n=f,s=b,n.length>0)le.log.info(`Found ${n.length} changed files for memory "${e}":`),n.forEach(x=>le.log.message(x));else{let x=!t;le.log.info(`No file changes detected for memory "${e}" since last ${x?"embedding":"deployment"}.`)}if(s.length>0)le.log.info(`Found ${s.length} deleted files for memory "${e}":`),s.forEach(x=>le.log.message(x));else{let x=!t;le.log.info(`No deleted file detected for memory "${e}" since last ${x?"embedding":"deployment"}.`)}}return n=[...new Set([...n,...l])],s=s.filter(f=>!n.includes(f)),{filesToDeploy:n,filesToDelete:s}}async function wt(e){let o=xt("git rev-parse HEAD").toString().trim();await Ar({memoryName:e,deployedCommitHash:o})}async function Dr(e){let o=xt("git rev-parse HEAD").toString().trim();await $r({memoryName:e,embeddedCommitHash:o})}import*as po from"@clack/prompts";import*as Pt from"@clack/prompts";import Lr from"fs/promises";import Nr from"path";var He=async e=>{let o=Nr.join(process.cwd(),"baseai","memory",e),t=Nr.join(o,"index.ts");try{await Lr.access(o)}catch{Pt.cancel(`Memory '${e}' does not exist.`),process.exit(1)}try{await Lr.access(t)}catch{Pt.cancel(`Index file for memory '${e}/index.ts' does not exist.`),process.exit(1)}return!0};import ma from"picocolors";var Uo=async({memoryName:e,documentName:o,spinner:t})=>{e||(po.cancel("Memory name is required. Use --memory or -m flag to specify."),process.exit(1)),o||(po.cancel("Document name is required. Use --document or -d flag to specify."),process.exit(1));let{memoryName:r,documentName:n}=br({memoryName:e,documentName:o});await He(r),t.start("Loading docs...");let s=await Pe(r);s.length===0&&(po.cancel(`No valid documents found in memory '${e}'.`),process.exit(1));let i=s.find(a=>a.name===n);return i||(t.stop("Stopped!"),po.cancel(`Doc: ${ma.cyan(n)} not found in memory ${r}`),process.exit(1)),{memoryFile:i,validMemoryName:r,validDocumentName:n}};import*as U from"@clack/prompts";import vt from"path";import ca from"fs/promises";async function Fr({memoryName:e,documentName:o,overwrite:t}){U.intro(h({text:"DEPLOY",sub:"Deploy a document"}));let r=U.spinner();try{let{validDocumentName:n,validMemoryName:s}=await Uo({spinner:r,memoryName:e,documentName:o});r.stop("Loaded docs"),await Ze({memoryName:s});let i=vt.join(process.cwd(),".baseai"),a=vt.join(i,"memory"),p=await Ae({spinner:r});p||(U.outro(`No account found. Skipping deployment. 
 Run: ${X("npx baseai@latest auth")}`),process.exit(1)),await da({account:p,spinner:r,memoryDir:a,overwrite:t,memoryName:s,documentName:n}),U.outro(h({text:"DEPLOYED",sub:"successfully",green:!0}))}catch(n){St({spinner:r,message:"An unexpected error occurred",error:n})}}async function da({account:e,spinner:o,overwrite:t,memoryDir:r,memoryName:n,documentName:s}){let i=vt.join(r,`${n}.json`);try{let a=await ca.readFile(i,"utf-8"),p=JSON.parse(a);p||(Ho({spinner:o,name:n,type:"memory"}),process.exit(1)),U.log.step(`Processing ${s} of memory: ${n}`);let m=(await Pe(n)).find(c=>c.name===s);m||(o.stop(`Document ${s} not found in memory ${n}`),process.exit(1)),await Et({memory:p,account:e,document:m,overwrite:t}),o.stop(`Finished processing document ${s} of memory ${n}`)}catch(a){Jo({spinner:o,name:n,error:a,type:"memory"}),process.exit(1)}}async function Et({memory:e,account:o,document:t,overwrite:r}){U.log.info(`Checking "${e.name}" memory for document "${t.name}".`);let n=await ao({account:o,memoryName:e.name});if(r){await lo({account:o,documents:[t],name:e.name}),U.log.success(`Document "${t.name}" uploaded to memory "${e.name}".`);return}let s=await jo(e.name);if(ua({localDocs:s,prodDocs:n,deployDoc:t.name})){await lo({account:o,documents:[t],name:e.name}),U.log.success(`Document "${t.name}" uploaded to memory "${e.name}".`);return}if(n.includes(t.name)){U.log.info(`Document "${t.name}" already exists in memory "${e.name}".`),U.log.info(`Use the --overwrite flag to overwrite the existing document in memory.
`);return}let{isProdSupersetOfLocal:p,areMutuallyExclusive:l,areOverlapping:m}=Ao({localDocs:s,prodDocs:n});if(p||l||m){U.log.warning(`The documents in memory "${e.name}" are not in sync with the production memory.`),U.log.warning("Memory deploy is currently in beta. We only support overwriting the prod memory on Langbase.com."),U.log.info(`Use the --overwrite flag to overwrite the existing document in memory.
`);return}}function ua({localDocs:e,prodDocs:o,deployDoc:t}){let r=new Set(e),n=new Set(o),s=r.has(t)&&!n.has(t);if(r.size!==n.size+1)return!1;for(let i of n)if(!r.has(i))return!1;return s}async function Gr({overwrite:e=!1}){let o=g.spinner();g.intro(h({text:"DEPLOY",sub:"Deploy your BaseAI project"}));try{await Mo({calledAsCommand:!1});let t=me.join(process.cwd(),".baseai"),r=me.join(t,"pipes"),n=await ga({spinner:o,pipesDir:r});n||g.outro(`No pipes found. Skipping deployment of pipes. 
Add a pipe by running: ${X("npx baseai@latest pipe")} command`);let s=me.join(t,"memory"),i=await Br({spinner:o,memoryDir:s}),a=me.join(t,"tools"),p=await ha({spinner:o,toolsDir:a}),l=await Ae({spinner:o});l||(g.outro(`No account found. Skipping deployment. 
 Run: ${X("npx baseai@latest auth")}`),process.exit(1)),i&&i.length>0&&await Pa({spinner:o,memory:i,memoryDir:s,account:l,overwrite:e}),n&&await ya({spinner:o,pipes:n,pipesDir:r,account:l}),g.outro(h({text:"DEPLOYED",sub:"successfully",green:!0})),g.log.warning(te(`Make sure ${X("LANGBASE_API_KEY")} exists in your production environment.`)),g.log.info(`${xe("Successfully deployed:")}
${xe(`- ${xo(n==null?void 0:n.length)} pipe${(n==null?void 0:n.length)!==1?"s":""}
- ${xo((p==null?void 0:p.length)??0)} tool${(p==null?void 0:p.length)!==1?"s":""}
- ${xo((i==null?void 0:i.length)??0)} memory${(i==null?void 0:i.length)!==1?"sets":""}`)}`)}catch(t){St({spinner:o,message:"An unexpected error occurred",error:t})}}async function ga({spinner:e,pipesDir:o}){e.start("Reading pipes directory");try{let r=(await mo.readdir(o)).filter(n=>me.extname(n)===".json");return e.stop(`Found ${r.length} pipe${r.length!==1?"s":""}`),r}catch(t){return Mt({spinner:e,dir:o,error:t}),null}}async function ha({spinner:e,toolsDir:o}){e.start("Reading tools directory");try{let r=(await mo.readdir(o)).filter(n=>me.extname(n)===".json");return e.stop(`Found ${r.length} tool${r.length!==1?"s":""}`),r}catch(t){return Mt({spinner:e,dir:o,error:t}),null}}async function ya({spinner:e,pipes:o,pipesDir:t,account:r}){for(let n of o)me.extname(n)===".json"&&(await new Promise(s=>setTimeout(s,500)),await Ca({spinner:e,pipe:n,pipesDir:t,account:r}))}async function Ca({spinner:e,pipe:o,pipesDir:t,account:r}){let n=me.join(t,o);e.start(`Processing pipe: ${o}`);try{let s=await mo.readFile(n,"utf-8"),i=JSON.parse(s);if(!i){Ho({spinner:e,name:o,type:"pipe"});return}e.stop(`Processed pipe: ${o}`),e.start(`Deploying pipe: ${i.name}`),i.model.includes(K)&&(e.stop(`Local Ollama model found: ${i.model}. It can not be deployed.`),e.start("Replacing Ollama model with OpenAI gpt-4o-mini model for deployment."),i.model="openai:gpt-4o-mini");try{await new Promise(p=>setTimeout(p,500));let a=await xa({pipe:i,account:r});e.stop(`Successfully deployed pipe: ${a.name}`)}catch(a){Jo({spinner:e,name:i.name,error:a,type:"pipe"})}}catch(s){wa({spinner:e,name:o,error:s})}}function ba(e){return{createUrl:"https://api.langbase.com/v1/pipes",updateUrl:`https://api.langbase.com/v1/pipes/${e}`}}async function xa({pipe:e,account:o}){var r;let{createUrl:t}=ba(e.name);try{let n=await ke(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.apiKey}`},body:JSON.stringify({...e,upsert:!0})});if(n.ok)return await n.json();let s=await n.json();throw new Error(`HTTP error! status: ${n.status}, message: ${(r=s.error)==null?void 0:r.message}`)}catch(n){throw console.error("Error in createNewPipe:",n),n}}function St({spinner:e,message:o,error:t}){e.stop(o),g.log.error(`${o}: ${t.message}`)}function Mt({spinner:e,dir:o,error:t}){e.stop("Failed to read build directory"),t.code==="ENOENT"?(g.log.error(`BaseAI Directory not found: ${o}`),g.log.info(`Run from the root of your project where the ${fa.cyan("baseai")} directory is located.`)):g.log.error(`Error reading directory: ${t.message}`)}function Ho({spinner:e,name:o,type:t}){e.stop(`Failed to extract ${t} configuration from ${o}`),g.log.error(`Invalid ${t} configuration`)}function Jo({spinner:e,error:o,name:t,type:r}){e.stop(`Failed to deploy ${r}: ${t}`),g.log.error(`Deployment error: ${o.message}`),process.exit(0)}function wa({spinner:e,name:o,error:t}){e.stop(`Error processing ${o}`),g.log.error(`File processing error: ${t.message}`)}async function Br({spinner:e,memoryDir:o}){e.start("Reading memory directory");try{let t=await mo.readdir(o);return e.stop(),t}catch(t){return Mt({spinner:e,dir:o,error:t}),null}}async function Pa({spinner:e,memory:o,memoryDir:t,account:r,overwrite:n}){for(let s of o)await qr({spinner:e,memoryName:s,memoryDir:t,account:r,overwrite:n})}async function qr({spinner:e,memoryName:o,memoryDir:t,account:r,overwrite:n}){let s=me.join(t,o),i=o.split(".")[0];e.start(`Processing memory: ${i}`);try{let a=await mo.readFile(s,"utf-8"),p=JSON.parse(a);if(!p){Ho({spinner:e,name:o,type:"memory"});return}g.log.step(`Processing documents for memory: ${i}`),No(p)&&(g.note(Fo(p)),g.cancel("Deployment cancelled. Please update your memory config file to the new format."),process.exit(1));let l=[],m=[],c=[];if(p.git.enabled){let{filesToDeploy:d,filesToDelete:f}=await qo({memoryName:i,config:p,account:r});l=d,m=f,c=await Pe(i),c=c.filter(b=>l.includes(b.name))}else c=await Pe(i),l=c.map(d=>d.name);l.length===0&&e.stop(`No documents to deploy for memory: ${i}. Skipping.`),e.stop(`Processed memory: ${o.split(".")[0]}`),e.start(`Deploying memory: ${p.name.split(".")[0]}`);try{await Ur({memory:p,documents:c,account:r,overwrite:n,isGitSync:p.git.enabled,docsToDelete:m}),e.stop(`Deployment finished memory: ${p.name}`)}catch(d){throw u("Error in upsertMemory:",d),d}}catch(a){throw Jo({spinner:e,name:o,error:a,type:"memory"}),e.stop(`Error processing memory: ${o}`),a}}async function Ur({memory:e,documents:o,account:t,overwrite:r,isGitSync:n=!1,docsToDelete:s=[]}){var a,p;let{createMemory:i}=co({memoryName:e.name});try{await new Promise(c=>setTimeout(c,800));let l=await ke(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify(e)});if(!l.ok){let c=await l.json();if((a=c.error)!=null&&a.message.includes("already exists")){if(!n){g.log.info(`Memory "${e.name}" already exists in production.`),await va({memory:e,account:t,documents:o,overwrite:r});return}if(n){g.log.info(`Memory "${e.name}" already exists. Updating changed documents.`),await Ta({memory:e,account:t,documents:o,overwrite:r}),(s==null?void 0:s.length)>0&&await jr({documents:s,name:e.name,account:t}),await wt(e.name),g.log.info(`Updated deployed commit hash for memory: ${e.name}`);return}}throw new Error(`HTTP error! status: ${l.status}, message: ${(p=c.error)==null?void 0:p.message}`)}u("Memory created successfully");let{name:m}=await l.json();await lo({documents:o,name:m,account:t}),n&&((s==null?void 0:s.length)>0&&await jr({documents:s,name:e.name,account:t}),await wt(e.name),g.log.info(`Updated deployed commit hash for memory: ${e.name}`))}catch(l){throw u("Error in createNewMemory:",l),l}}async function lo({documents:e,name:o,account:t}){for(let r of e)try{g.log.message(`Uploading document: ${r.name} ....`),await new Promise(i=>setTimeout(i,800));let n=await Ma({documentName:r.name,memoryName:o,account:t,meta:r.meta}),s=await Ia(n,r.blob);u(`Upload response status: ${s.status}`),g.log.message(`Uploaded document: ${r.name}`)}catch(n){throw n}}async function jr({documents:e,name:o,account:t}){g.log.info(`Deleting documents from memory: ${o}`);for(let r of e)try{g.log.message(`Deleting document: ${r} ....`),await new Promise(s=>setTimeout(s,800));let n=await Aa({documentName:r,memoryName:o,account:t});u(`Delete response status: ${n.status}`),g.log.message(`Deleted document: ${r}`)}catch(n){throw n}g.log.info(`Deleted documents from memory: ${o}`)}async function va({memory:e,account:o,documents:t,overwrite:r}){g.log.info(`Fetching "${e.name}" memory documents.`);let n=await ao({account:o,memoryName:e.name}),s=await jo(e.name),{areListsSame:i,isProdSubsetOfLocal:a,isProdSupersetOfLocal:p,areMutuallyExclusive:l,areOverlapping:m}=Ao({localDocs:s,prodDocs:n});if(r)return await Hr({memory:e,documents:t,account:o}),!0;if(i)return g.log.info(`Documents in local and prod are the same. Skipping deployment for memory: "${e.name}".`),!0;if(a)return await Sa({memory:e,prodDocs:n,documents:t,account:o}),!0;if(p||l||m)return await Ea({memory:e,localDocs:s,prodDocs:n,documents:t,account:o}),!0}async function Ea({memory:e,localDocs:o,prodDocs:t,documents:r,account:n}){if(Er(o,t),g.log.warning("Memory deploy is currently in beta. We only support overwriting the prod memory on Langbase.com."),!await g.confirm({message:"Do you want to overwrite the prod memory? This will delete all prod documents.",initialValue:!1})){g.log.message(`Skipping memory deployment for "${e.name}".`);return}await Hr({memory:e,documents:r,account:n})}async function Sa({memory:e,prodDocs:o,documents:t,account:r}){g.log.info(`Prod has missing documents. Uploading new documents to ${e.name}.`);let n=t.filter(s=>{let i=!o.includes(s.name);return i||g.log.message(`Document "${s.name}" already exists. Skipping.`),i});await new Promise(s=>setTimeout(s,500)),await lo({documents:n,name:e.name,account:r})}async function ao({account:e,memoryName:o}){var i;let{listDocuments:t}=co({memoryName:o});await new Promise(a=>setTimeout(a,500));let r=await ke(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`}});if(!r.ok){let p=(i=(await r.json()).error)==null?void 0:i.message;if(p!=null&&p.includes("Invalid memory name."))return g.log.info(`Memory "${o}" does not exist in production.`),[];throw new Error(`HTTP error! status: ${r.status}, message: ${p}`)}return(await r.json()).map(a=>a.name)}async function Ma({documentName:e,memoryName:o,account:t,meta:r}){var s;let{uploadDocument:n}=co({memoryName:o});try{let i=await ke(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify({meta:r,memoryName:o,fileName:e})});if(!i.ok){let p=await i.json();throw new Error(`HTTP error! status: ${i.status}, message: ${(s=p.error)==null?void 0:s.message}`)}let{signedUrl:a}=await i.json();if(!a)throw new Error("Invalid signedUrl received from API");return a}catch(i){throw u("Error in getSignedUploadUrl:",i),i}}async function Aa({documentName:e,memoryName:o,account:t}){var n;let{deleteDocument:r}=co({memoryName:o,documentName:e});try{let s=await ke(r,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`}});if(!s.ok){let i=await s.json();throw new Error(`HTTP error! status: ${s.status}, message: ${(n=i.error)==null?void 0:n.message}`)}return s}catch(s){throw u("Error in deleteDocument:",s),s}}async function Ia(e,o){let t=o.type;P.ACCEPTED_MIME_TYPES.includes(t)||(u(`Unsupported MIME type ${t}. Defaulting to text/plain`),t="text/plain");try{let n=await ke(e,{method:"PUT",headers:{"Content-Type":t},body:o});if(!n.ok){let s=await n.text();throw new Error(`HTTP error! status: ${n.status}, message: ${s}`)}return n}catch(n){throw u("Error in uploadDocument:",n),n}}function co({memoryName:e,documentName:o}){let t="https://api.langbase.com/v1",r=`${t}/memory`,n=`${t}/memory/${e}`,s=`${t}/memory/documents`,i=`${t}/memory/${e}/documents`,a=`${t}/memory/${e}/documents/${o}`;return{listDocuments:i,deleteMemory:n,deleteDocument:a,createMemory:r,uploadDocument:s}}async function Hr({memory:e,documents:o,account:t}){g.log.message(`Overwriting memory "${e.name}" in prod at Langbase.com with local documents.`),u(`Deleting old memory: ${e.name}`);let{deleteMemory:r}=co({memoryName:e.name});await new Promise(s=>setTimeout(s,500));let n=await ke(r,{method:"DELETE",headers:{Authorization:`Bearer ${t.apiKey}`}});if(!n.ok){let s=await n.text();throw new Error(`HTTP error! status: ${n.status}, message: ${s}`)}g.log.message(`Overwriting memory: ${e.name}`),await new Promise(s=>setTimeout(s,1e3)),await Ur({memory:e,documents:o,account:t,overwrite:!0})}async function Ta({memory:e,account:o,documents:t,overwrite:r}){for(let n in t)await new Promise(s=>setTimeout(s,800)),await Et({memory:e,account:o,document:t[n],overwrite:!0})}async function Jr({memoryName:e,overwrite:o}){let t=g.spinner();try{g.intro(h({text:"BUILDING",sub:"baseai..."})),await Ze({memoryName:e}),console.log(""),g.outro(h({text:"BUILD",sub:"complete",green:!0})),g.intro(h({text:"DEPLOY",sub:"Deploy your BaseAI Memory"}));let r=me.join(process.cwd(),".baseai"),n=me.join(r,"memory"),s=await Br({spinner:t,memoryDir:n});if(!(s!=null&&s.includes(`${e}.json`))){g.log.error(`Memory "${e}" not found.`);return}let i=await Ae({spinner:t});i||(g.outro(`No account found. Skipping deployment. 
 Run: ${X("npx baseai@latest auth")}`),process.exit(1)),await qr({spinner:t,memoryName:`${e}.json`,memoryDir:n,account:i,overwrite:o}),g.outro(`Successfully deployed memory: ${e}`),process.exit(0)}catch(r){r instanceof Error?r.code==="ENOENT"?g.log.error("Directory or file not found. Make sure you're in the correct project directory and the memory exists."):g.log.error(`Error deploying memory: ${r.message}`):g.log.error("An unknown error occurred while deploying memory."),process.exit(1)}}import*as be from"@clack/prompts";import{outro as Bp}from"@clack/prompts";import{serve as qp}from"@hono/node-server";import Up from"figures";import{Hono as Hp}from"hono";import{prettyJSON as Jp}from"hono/pretty-json";import{trimTrailingSlash as Kp}from"hono/trailing-slash";import zo from"picocolors";import{z as ne}from"@hono/zod-openapi";import{HTTPException as Kr}from"hono/http-exception";import{ZodError as _a}from"zod";import{generateErrorMessage as Cu}from"zod-error";import{fromZodError as ka}from"zod-validation-error";var Ra=ne.enum(["BAD_REQUEST","FORBIDDEN","INTERNAL_SERVER_ERROR","USAGE_EXCEEDED","DISABLED","NOT_FOUND","CONFLICT","RATE_LIMITED","UNAUTHORIZED","PRECONDITION_FAILED","INSUFFICIENT_PERMISSIONS"]);var xu=ne.object({success:ne.literal(!1).openapi({description:"Indicates that the request was not successful"}),error:ne.object({code:Ra.openapi({description:"A machine readable error code.",example:"INTERNAL_SERVER_ERROR"}),status:ne.number().openapi({description:"The HTTP status code"}),message:ne.string().openapi({description:"A human readable explanation of what went wrong"}),docs:ne.string().openapi({description:"A link to our documentation with more details about this error code",example:"https://langbase.com/docs/api-reference/errors/bad_request"}),cause:ne.instanceof(_a).optional(),rateLimit:ne.object({limit:ne.number().openapi({description:"The maximum number of requests that you can make per hour"}),remaining:ne.number().openapi({description:"The number of requests remaining in the current rate limit window"}),reset:ne.number().openapi({description:"The time at which the current rate limit window resets, in UTC epoch seconds"})}).optional()})});function Vr(e){switch(e){case"BAD_REQUEST":return 400;case"UNAUTHORIZED":return 401;case"FORBIDDEN":case"DISABLED":case"INSUFFICIENT_PERMISSIONS":case"USAGE_EXCEEDED":return 403;case"NOT_FOUND":return 404;case"CONFLICT":return 409;case"PRECONDITION_FAILED":return 412;case"RATE_LIMITED":return 429;case"INTERNAL_SERVER_ERROR":return 500}}var A=class extends Kr{constructor({status:o,code:t,message:r,rateLimit:n,docs:s}){super(o||Vr(t),{message:r}),this.code=t,this.success=!1,this.rateLimit=n,this.docs=s}},Je=class e extends Kr{constructor({code:o,validationResult:t,customMessage:r}){let n="";if(t.error){let s=r||"",i=ka(t.error).toString();n=`${s} HINT: ${i}`.trim()}super(Vr(o),{message:n}),this.code=o,this.cause=t.error}static handle({code:o,result:t,message:r}){if(!t.success)throw new e({code:o,validationResult:t,customMessage:r})}};function zr(e,o){return e instanceof A?o.json({success:!1,error:{code:e.code,status:e.status,message:e.message,docs:e.docs||`https://langbase.com/docs/api-reference/errors/${e.code.toLowerCase()}`,rateLimit:e.rateLimit}},{status:e.status}):e instanceof Je?o.json({success:!1,error:{code:e.code,status:e.status,message:e.message,docs:`https://langbase.com/docs/api-reference/errors/${e.code.toLowerCase()}`,cause:e.cause}},{status:e.status}):o.json({success:!1,error:{code:"INTERNAL_SERVER_ERROR",status:500,message:"Something unexpected happened.",docs:"https://langbase.com/docs/api-reference/errors/internal_server_error"}},{status:500})}import{cors as Oa}from"hono/cors";var Xr=Oa({origin:"*",maxAge:86400,allowMethods:["GET","POST","OPTIONS"],allowHeaders:["Content-Type","Authorization"]});var Yr=()=>async function(o,t){await t(),o.res.headers.set("lb-powered-by","Langbase"),o.res.headers.set("powered-by","BaseAI"),o.res.headers.set("env","local")};import"hono";var Wr=()=>async function(o,t){if(o.req.method==="OPTIONS")return new Response(null);await t()};var Qr=e=>e.get("/",o=>o.json({success:!0,message:"BaseAI Local API",link:"https://langbase.com/docs"}));function Zr(e){let o=e.messages.filter(t=>t.role!=="system");return o&&o.length>0?o:[]}var H="OpenAI",V="Anthropic",$="Together",Re="Google",ce="Groq",uo="Cohere",ve="Fireworks AI",Se="Perplexity";var Ko="xAI",en="ollama",At={[H]:[{id:"gpt-4o",provider:H,promptCost:5,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4o-2024-08-06",provider:H,promptCost:2.5,completionCost:10,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4o-mini",provider:H,promptCost:.15,completionCost:.6,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-turbo",provider:H,promptCost:10,completionCost:30,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-turbo-preview",provider:H,promptCost:10,completionCost:30,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-0125-preview",provider:H,promptCost:10,completionCost:30,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-1106-preview",provider:H,promptCost:10,completionCost:30,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4",provider:H,promptCost:30,completionCost:60,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-0613",provider:H,promptCost:30,completionCost:60,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-4-32k",provider:H,promptCost:60,completionCost:120,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-3.5-turbo",provider:H,promptCost:.5,completionCost:1.5,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-3.5-turbo-0125",provider:H,promptCost:.5,completionCost:1.5,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-3.5-turbo-1106",provider:H,promptCost:1,completionCost:2,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gpt-3.5-turbo-16k",provider:H,promptCost:3,completionCost:4,toolSupport:{toolChoice:!0,parallelToolCalls:!0}}],[$]:[{id:"meta-llama/Llama-3.3-70B-Instruct-Turbo",provider:$,promptCost:.88,completionCost:.88},{id:"meta-llama/Meta-Llama-3.1-405B-Instruct-Turbo",provider:$,promptCost:5,completionCost:5,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"meta-llama/Meta-Llama-3.1-70B-Instruct-Turbo",provider:$,promptCost:.88,completionCost:.88,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo",provider:$,promptCost:.18,completionCost:.18,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"meta-llama/Llama-3-70b-chat-hf",provider:$,promptCost:.9,completionCost:.9},{id:"meta-llama/Llama-3-8b-chat-hf",provider:$,promptCost:.2,completionCost:.2},{id:"togethercomputer/Llama-2-7B-32K-Instruct",provider:$,promptCost:.2,completionCost:.2},{id:"meta-llama/Llama-2-13b-chat-hf",provider:$,promptCost:.225,completionCost:.225},{id:"meta-llama/Llama-2-70b-chat-hf",provider:$,promptCost:.9,completionCost:.9},{id:"google/gemma-7b-it",provider:$,promptCost:.2,completionCost:.2},{id:"google/gemma-2b-it",provider:$,promptCost:.1,completionCost:.1},{id:"mistralai/Mistral-7B-Instruct-v0.1",provider:$,promptCost:.2,completionCost:.2,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"mistralai/Mistral-7B-Instruct-v0.2",provider:$,promptCost:.2,completionCost:.2},{id:"mistralai/Mixtral-8x7B-Instruct-v0.1",provider:$,promptCost:.6,completionCost:.6,toolSupport:{toolChoice:!0,parallelToolCalls:!1}},{id:"mistralai/Mixtral-8x22B-Instruct-v0.1",provider:$,promptCost:1.2,completionCost:1.2},{id:"databricks/dbrx-instruct",provider:$,promptCost:1.2,completionCost:1.2}],[V]:[{id:"claude-3-5-sonnet-latest",provider:V,promptCost:3,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-5-sonnet-20240620",provider:V,promptCost:3,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-opus-20240229",provider:V,promptCost:15,completionCost:75,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-sonnet-20240229",provider:V,promptCost:3,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-haiku-20240307",provider:V,promptCost:.25,completionCost:1.25,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"claude-3-5-haiku-20241022",provider:V,promptCost:1,completionCost:5,toolSupport:{toolChoice:!0,parallelToolCalls:!0}}],[ce]:[{id:"llama-3.3-70b-versatile",provider:ce,promptCost:.59,completionCost:.79},{id:"llama-3.1-70b-versatile",provider:ce,promptCost:.59,completionCost:.79},{id:"llama-3.1-8b-instant",provider:ce,promptCost:.59,completionCost:.79},{id:"llama3-70b-8192",provider:ce,promptCost:.59,completionCost:.79},{id:"llama3-8b-8192",provider:ce,promptCost:.05,completionCost:.1},{id:"mixtral-8x7b-32768",provider:ce,promptCost:.27,completionCost:.27},{id:"gemma2-9b-it",provider:ce,promptCost:.2,completionCost:.2},{id:"gemma-7b-it",provider:ce,promptCost:.07,completionCost:.07}],[Re]:[{id:"gemini-1.5-pro-latest",provider:Re,promptCost:3.5,completionCost:10.5,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gemini-1.5-flash-latest",provider:Re,promptCost:.075,completionCost:.3,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gemini-1.5-flash-8b-latest",provider:Re,promptCost:.0375,completionCost:.15,toolSupport:{toolChoice:!0,parallelToolCalls:!0}},{id:"gemini-pro",provider:Re,promptCost:.5,completionCost:1.5,toolSupport:{toolChoice:!1,parallelToolCalls:!1}}],[uo]:[{id:"command-r",provider:uo,promptCost:.5,completionCost:1.5},{id:"command-r-plus",provider:uo,promptCost:3,completionCost:15}],[ve]:[{id:"llama-v3p3-70b-instruct",provider:ve,promptCost:.88,completionCost:.88},{id:"llama-v3p1-405b-instruct",provider:ve,promptCost:3,completionCost:3},{id:"llama-v3p1-70b-instruct",provider:ve,promptCost:.9,completionCost:.9},{id:"llama-v3p1-8b-instruct",provider:ve,promptCost:.2,completionCost:.2},{id:"yi-large",provider:ve,promptCost:3,completionCost:3},{id:"llama-v3-70b-instruct",provider:ve,promptCost:.9,completionCost:.9}],[Se]:[{id:"llama-3.1-sonar-huge-128k-online",provider:Se,promptCost:5,completionCost:5,requestCost:.005},{id:"llama-3.1-sonar-large-128k-online",provider:Se,promptCost:1,completionCost:1,requestCost:.005},{id:"llama-3.1-sonar-small-128k-online",provider:Se,promptCost:.2,completionCost:.2,requestCost:.005},{id:"llama-3.1-sonar-large-128k-chat",provider:Se,promptCost:1,completionCost:1},{id:"llama-3.1-sonar-small-128k-chat",provider:Se,promptCost:.2,completionCost:.2}],[Ko]:[{id:"grok-beta",provider:Ko,promptCost:5,completionCost:15,toolSupport:{toolChoice:!0,parallelToolCalls:!1}}]},on=["gpt-4o","gpt-4o-2024-08-06","gpt-4o-mini","gpt-4-turbo","gpt-4-turbo-preview","gpt-4-0125-preview","gpt-3.5-turbo","gpt-3.5-turbo-0125","gpt-3.5-turbo-1106","gpt-4-1106-preview","mistralai/Mistral-7B-Instruct-v0.1","mistralai/Mixtral-8x7B-Instruct-v0.1","gemini-1.5-pro-latest","gemini-1.5-flash-latest"];var tn=408,rn="Output should be in JSON format.";function nn({pipe:e,systemPrompt:o}){if(!(e!=null&&e.json))return o;let t=e.model.split(":")[1];if(!on.includes(t))return o;let r=$a(e);return`${o}

${r}`}function $a(e){var r;let o=((r=e.messages.find(n=>n.role==="system"&&n.name==="json"))==null?void 0:r.content)||"";return o===""?rn:o}function sn({pipe:e,similarChunks:o}){let t="";return t=Da(e),t=Na({pipe:e,systemPrompt:t}),t=nn({pipe:e,systemPrompt:t}),t=Fa({pipe:e,systemPrompt:t,similarChunks:o}),[{role:"system",content:t}]}function Da(e){var s;let o="You are a helpful AI Chat assistant",t=((s=e.messages.find(i=>i.role==="system"&&!i.name))==null?void 0:s.content)||"";return t!==""?t:o}function La(e){var o;return((o=e.messages.find(t=>t.role==="system"&&t.name==="safety"))==null?void 0:o.content)||""}function Na({pipe:e,systemPrompt:o}){let t=La(e);return t=t!==""?`"""SAFETY GUIDELINE: ${t}"""`:"",`${o} 
 ${t}`.trim()}function Fa({pipe:e,systemPrompt:o,similarChunks:t}){var l;if(!t||t.length===0)return o;let r=t.map(m=>`${m.text} 

 Source: ${m.attributes.docName}`).join(`

`),n=((l=e.messages.find(m=>m.role==="system"&&m.name==="rag"))==null?void 0:l.content)||"",i=n!==""?n:eo,a=`"""CONTEXT:
 ${r}"""`,p=`"""${i}""" 

 ${a}`;return`${o} 

 ${p}`.trim()}function an({pipe:e,messages:o,variables:t}){let r=ja({pipe:e,variables:t});return{messages:Ga({messages:o,variablesMap:r}),variablesMap:r}}function ja({pipe:e,variables:o}){let t=e.variables?e.variables.length>0:!1,r=o?o.length>0:!1,n=t?e.variables:[],s=r?o:[],i=new Map;t&&n.forEach(p=>i.set(p.name,p.value)),r&&(s==null||s.forEach(p=>i.set(p.name,p.value)));let a=Array.from(i,([p,l])=>({name:p,value:l}));return u("finalVariables",a),i}function Ga({messages:e,variablesMap:o}){let t=/{{(.*?)}}/g;return e.map(r=>{var i;if(!r.content&&r.role==="assistant"&&((i=r.tool_calls)==null?void 0:i.length)||!r.content)return r;let s=r.content.replace(t,(a,p)=>{let l=p.trim();return o.get(l)||a});return{...r,content:s}})}function pn({pipe:e,messages:o,similarChunks:t,variables:r}){try{let n=sn({pipe:e,similarChunks:t}),s=Zr(e),i=[...n,...s,...o],{messages:a}=an({pipe:e,messages:i,variables:r});return a}catch(n){throw u("Error get-run-thread.ts:",n),new A({code:"INTERNAL_SERVER_ERROR",message:"Something unexpected happened. Error generating thread of messages."})}}var Ba={baseURL:"https://api.anthropic.com/v1",headers:({llmApiKey:e,endpoint:o})=>{let t={"X-API-Key":`${e}`,"anthropic-version":"2023-06-01"};return o==="chatComplete"&&(t["anthropic-beta"]="messages-2023-12-15"),t},chatComplete:"/messages"},ln=Ba;var ye=(e,o)=>({error:{message:`Invalid response received from ${o}: ${JSON.stringify(e)}`,type:null,param:null,code:null},provider:o}),ee=({message:e,type:o,param:t,code:r},n)=>({error:{message:`${e}`,type:o??null,param:t??null,code:r??null},provider:n}),qa={mp4:"video/mp4",jpeg:"image/jpeg",jpg:"image/jpeg",png:"image/png",bmp:"image/bmp",tiff:"image/tiff",webp:"image/webp",pdf:"application/pdf",mp3:"audio/mp3",wav:"audio/wav",txt:"text/plain",mov:"video/mov",mpeg:"video/mpeg",mpg:"video/mpg",avi:"video/avi",wmv:"video/wmv",mpegps:"video/mpegps",flv:"video/flv"},mn=e=>{let o=e.split("."),t=o[o.length-1];return qa[t]};var Ua=e=>{let o=[],t=e.tool_calls&&e.tool_calls.length;return e.content&&typeof e.content=="string"?o.push({type:"text",text:e.content}):e.content&&typeof e.content=="object"&&e.content.length&&e.content[0].text&&o.push({type:"text",text:e.content[0].text}),t&&e.tool_calls.forEach(r=>{o.push({type:"tool_use",name:r.function.name,id:r.id,input:JSON.parse(r.function.arguments)})}),{role:e.role,content:o}},cn=e=>({role:"user",content:[{type:"tool_result",tool_use_id:e.tool_call_id,content:e.content}]}),dn={model:{param:"model",default:"claude-3-haiku",required:!0},messages:[{param:"messages",required:!0,transform:e=>{let o=[],t;return e.messages&&e.messages.forEach(r=>{if(r.role!=="system"){if(r.role==="assistant")o.push(Ua(r));else if(r.content&&typeof r.content=="object"&&r.content.length){let n={role:r.role,content:[]};r.content.forEach(s=>{if(s.type==="text")n.content.push({type:s.type,text:s.text});else if(s.type==="image_url"&&s.image_url&&s.image_url.url){let i=s.image_url.url.split(";");if(i.length===2){let p=i[1].split(",")[1],l=i[0].split(":");if(l.length===2&&p){let m=l[1];n.content.push({type:"image",source:{type:"base64",media_type:m,data:p}})}}}}),o.push(n)}else if(r.role==="tool")if(t==="tool"){let s=cn(r).content;o[o.length-1].content.push(s[0])}else o.push(cn(r));else o.push({role:r.role,content:r.content});t=r.role}}),o}},{param:"system",required:!1,transform:e=>{let o="";return e.messages&&e.messages.forEach(t=>{t.role==="system"&&t.content&&typeof t.content=="object"&&t.content[0].text?o=t.content[0].text:t.role==="system"&&typeof t.content=="string"&&(o=t.content)}),o}}],tools:{param:"tools",required:!1,transform:e=>{let o=[];return e.tools&&e.tools.forEach(t=>{var r,n,s,i;t.function&&o.push({name:t.function.name,description:((r=t.function)==null?void 0:r.description)||"",input_schema:{type:((n=t.function.parameters)==null?void 0:n.type)||"object",properties:((s=t.function.parameters)==null?void 0:s.properties)||{},required:((i=t.function.parameters)==null?void 0:i.required)||[]}})}),o}},tool_choice:{param:"tool_choice",required:!1,transform:e=>{let o={};return e.tool_choice&&(typeof e.tool_choice=="string"?e.tool_choice==="required"?o={type:"any"}:e.tool_choice==="auto"&&(o={type:"auto"}):typeof e.tool_choice=="object"&&(o={type:"tool",name:e.tool_choice.function.name})),e.parallel_tool_calls||(o={...o,disable_parallel_tool_use:!0}),o}},max_tokens:{param:"max_tokens",required:!0},temperature:{param:"temperature",default:1,min:0,max:1},top_p:{param:"top_p",default:-1,min:-1},top_k:{param:"top_k",default:-1},stop:{param:"stop_sequences"},stream:{param:"stream",default:!1},user:{param:"metadata.user_id"}},un=(e,o)=>{var t,r;if(o!==200&&"error"in e)return{error:{message:(t=e.error)==null?void 0:t.message,type:(r=e.error)==null?void 0:r.type,param:null,code:null},provider:V};if("content"in e){let{input_tokens:n=0,output_tokens:s=0}=e==null?void 0:e.usage,i="";e.content.length&&e.content[0].type==="text"&&(i=e.content[0].text);let a=[];return e.content.forEach(p=>{p.type==="tool_use"&&a.push({id:p.id,type:"function",function:{name:p.name,arguments:JSON.stringify(p.input)}})}),{id:e.id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:e.model,provider:V,choices:[{message:{role:"assistant",content:i,tool_calls:a.length?a:void 0},index:0,logprobs:null,finish_reason:e.stop_reason}],usage:{prompt_tokens:n,completion_tokens:s,total_tokens:n+s}}}return ye(e,V)},fn=(e,o)=>{var p,l,m,c;let t=e.trim();if(t.startsWith("event: ping")||t.startsWith("event: content_block_stop"))return;if(t.startsWith("event: message_stop"))return`data: [DONE]

`;t=t.replace(/^event: content_block_delta[\r\n]*/,""),t=t.replace(/^event: content_block_start[\r\n]*/,""),t=t.replace(/^event: message_delta[\r\n]*/,""),t=t.replace(/^event: message_start[\r\n]*/,""),t=t.replace(/^data: /,""),t=t.trim();let r=JSON.parse(t);if(r.type==="message_start")return`data: ${JSON.stringify({id:o,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:V,choices:[{delta:{role:"assistant",content:""},index:0,logprobs:null,finish_reason:null}]})}

`;if(r.type==="message_delta")return`data: ${JSON.stringify({id:o,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:V,choices:[{index:0,delta:{},finish_reason:(p=r.delta)==null?void 0:p.stop_reason}]})}

`;let n=[],s=r.type==="content_block_start"&&!!((l=r.content_block)!=null&&l.id),i=r.type==="content_block_delta"&&!!r.delta.partial_json,a=r.index;return s&&r.content_block?n.push({index:a,id:r.content_block.id,type:"function",function:{name:r.content_block.name,arguments:""}}):i&&n.push({index:a,function:{arguments:r.delta.partial_json}}),`data: ${JSON.stringify({id:o,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:V,choices:[{delta:{content:(m=r.delta)==null?void 0:m.text,tool_calls:n.length?n:void 0},index:0,logprobs:null,finish_reason:((c=r.delta)==null?void 0:c.stop_reason)??null}]})}

`};var Ha={chatComplete:dn,api:ln,responseTransforms:{chatComplete:un,"stream-chatComplete":fn}},gn=Ha;var Ja={baseURL:"https://api.openai.com/v1",headers:e=>({Authorization:`Bearer ${e}`}),chatComplete:"/chat/completions"},hn=Ja;var yn={model:{param:"model",required:!0,default:"gpt-4o-mini"},messages:{param:"messages",default:""},functions:{param:"functions"},function_call:{param:"function_call"},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},n:{param:"n",default:1},stream:{param:"stream",default:!1},stop:{param:"stop"},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},logit_bias:{param:"logit_bias"},user:{param:"user"},seed:{param:"seed"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"},logprobs:{param:"logprobs",default:!1},top_logprobs:{param:"top_logprobs"}};var Ka={api:hn,chatComplete:yn},Cn=Ka;var Va={baseURL:"https://api.together.xyz",headers:e=>({Authorization:`Bearer ${e}`}),chatComplete:"/v1/chat/completions",complete:"/v1/completions",embed:"/v1/embeddings"},bn=Va;var xn={model:{param:"model",required:!0,default:"mistralai/Mistral-7B-Instruct-v0.1"},messages:{param:"messages",required:!0,default:""},max_tokens:{param:"max_tokens",required:!0,default:128,min:1},stop:{param:"stop"},temperature:{param:"temperature"},top_p:{param:"top_p"},top_k:{param:"top_k"},frequency_penalty:{param:"repetition_penalty"},stream:{param:"stream",default:!1},logprobs:{param:"logprobs"},tools:{param:"tools"},tool_choice:{param:"tool_choice"},response_format:{param:"response_format"}};var za={chatComplete:xn,api:bn},wn=za;var Xa={baseURL:"https://api.groq.com/openai/v1",headers:e=>({Authorization:`Bearer ${e}`}),chatComplete:"/chat/completions"},Pn=Xa;var vn={model:{param:"model",required:!0,default:"mixtral-8x7b-32768"},messages:{param:"messages",default:""},max_tokens:{param:"max_tokens",default:100,min:0},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},stream:{param:"stream",default:!1},stop:{param:"stop"},n:{param:"n",default:1,max:1,min:1}};var Ya={chatComplete:vn,api:Pn},En=Ya;var Wa={baseURL:"https://generativelanguage.googleapis.com/v1beta",headers:()=>({"Content-Type":"application/json"}),getEndpoint:({endpoint:e,llmApiKey:o,model:t,stream:r})=>{let n=e;switch(r&&(n=`stream-${e}`),n){case"chatComplete":return`/models/${t}:generateContent?key=${o}`;case"stream-chatComplete":return`/models/${t}:streamGenerateContent?key=${o}`}}},Sn=Wa;var fo=e=>{let o={};return e.temperature&&(o.temperature=e.temperature),e.top_p&&(o.topP=e.top_p),e.top_k&&(o.topK=e.top_k),e.max_tokens&&(o.maxOutputTokens=e.max_tokens),e.stop&&(o.stopSequences=e.stop),o},Qa=e=>{switch(e){case"assistant":return"model";case"tool":return"function";case"system":return"user";default:return e}},Za=e=>{if(typeof e=="object"&&e.type==="function")return"ANY";if(typeof e=="string")switch(e){case"auto":return"AUTO";case"none":return"NONE";case"required":return"ANY"}},Mn={model:{param:"model",required:!0,default:"gemini-pro"},messages:{param:"contents",default:"",transform:e=>{var r;let o=[],t;return(r=e.messages)==null||r.forEach(n=>{var p;let s=Qa(n.role),i=[];n.role==="assistant"&&n.tool_calls?n.tool_calls.forEach(l=>{i.push({functionCall:{name:l.function.name,args:JSON.parse(l.function.arguments)}})}):n.role==="tool"&&typeof n.content=="string"?i.push({functionResponse:{name:n.name??"lb-random-tool-name",response:{content:n.content}}}):n.content&&typeof n.content=="object"?n.content.forEach(l=>{var m;if(l.type==="text"&&i.push({text:l.text}),l.type==="image_url"){let{url:c}=l.image_url||{};if(!c)return;if(c.startsWith("data:")){let[d,f]=c.split(";base64,"),b=d.split(":")[1];i.push({inlineData:{mimeType:b,data:f}})}else c.startsWith("gs://")||c.startsWith("https://")||c.startsWith("http://")?i.push({fileData:{mimeType:mn(c),fileUri:c}}):i.push({inlineData:{mimeType:"image/jpeg",data:(m=l.image_url)==null?void 0:m.url}})}}):typeof n.content=="string"&&i.push({text:n.content}),t===s&&!((p=e.model)!=null&&p.includes("vision"))?o[o.length-1].parts.push(...i):o.push({role:s,parts:i}),t=s}),o}},temperature:{param:"generationConfig",transform:e=>fo(e)},top_p:{param:"generationConfig",transform:e=>fo(e)},top_k:{param:"generationConfig",transform:e=>fo(e)},max_tokens:{param:"generationConfig",transform:e=>fo(e)},stop:{param:"generationConfig",transform:e=>fo(e)},tools:{param:"tools",default:"",transform:e=>{var t;let o=[];return(t=e.tools)==null||t.forEach(r=>{r.type==="function"&&o.push(r.function)}),[{functionDeclarations:o}]}},tool_choice:{param:"tool_config",default:"",transform:e=>{if(e.tool_choice){let o=[];typeof e.tool_choice=="object"&&e.tool_choice.type==="function"&&o.push(e.tool_choice.function.name);let t={function_calling_config:{mode:Za(e.tool_choice)}};return o.length>0&&(t.function_calling_config.allowed_function_names=o),t}}}},An=(e,o)=>{var r,n;let t=Array.isArray(e)?(r=e.find(s=>"error"in s))==null?void 0:r.error:"error"in e?e.error:null;return o!==200&&t?ee({message:(t==null?void 0:t.message)??"",type:(t==null?void 0:t.status)??null,param:null,code:t!=null&&t.code?`${t.code}`:null},_):"candidates"in e?{id:crypto.randomUUID(),object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:_,choices:((n=e.candidates)==null?void 0:n.map(s=>{var a,p,l,m,c;if(s.finishReason==="MAX_TOKENS"&&!s.content)throw Error("The response exceeded your Max Tokens limit parameter. Increase the limit or change the prompt accordingly.");let i={role:"assistant",content:""};return(p=(a=s.content)==null?void 0:a.parts[0])!=null&&p.text?i={role:"assistant",content:(l=s.content.parts[0])==null?void 0:l.text}:(c=(m=s.content)==null?void 0:m.parts[0])!=null&&c.functionCall&&(i={role:"assistant",content:null,tool_calls:s.content.parts.map(d=>{if(d.functionCall)return{id:crypto.randomUUID(),type:"function",function:{name:d.functionCall.name,arguments:JSON.stringify(d.functionCall.args)}}})}),{message:i,index:s.index,finish_reason:s.finishReason}}))??[],usage:{prompt_tokens:e.usageMetadata.promptTokenCount,completion_tokens:e.usageMetadata.candidatesTokenCount,total_tokens:e.usageMetadata.totalTokenCount}}:ye(e,_)},In=(e,o)=>{var n;let t=e.trim();if(t.startsWith("[")&&(t=t.slice(1)),t.endsWith(",")&&(t=t.slice(0,t.length-1)),t.endsWith("]")&&(t=t.slice(0,t.length-2)),t=t.replace(/^data: /,""),t=t.trim(),t==="[DONE]")return`data: ${t}

`;let r=JSON.parse(t);return`data: ${JSON.stringify({id:o,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:"google",choices:((n=r.candidates)==null?void 0:n.map((s,i)=>{var p,l,m;let a={role:"assistant",content:""};return(p=s.content.parts[0])!=null&&p.text?a={role:"assistant",content:(l=s.content.parts[0])==null?void 0:l.text}:(m=s.content.parts[0])!=null&&m.functionCall&&(a={role:"assistant",tool_calls:s.content.parts.map((c,d)=>{if(c.functionCall)return{index:d,id:crypto.randomUUID(),type:"function",function:{name:c.functionCall.name,arguments:JSON.stringify(c.functionCall.args)}}})}),{delta:a,index:s.index??i,finish_reason:s.finishReason}}))??[]})}

`};var ep={api:Sn,chatComplete:Mn,responseTransforms:{chatComplete:An,"stream-chatComplete":In}},Tn=ep;var op={baseURL:"https://api.cohere.ai/v1",headers:e=>({Authorization:`Bearer ${e}`}),chatComplete:"/chat"},_n=op;var kn={model:{param:"model",default:"command-r",required:!0},messages:[{param:"message",required:!0,transform:e=>{let o="";if(e.messages){let t=e.messages,r=t[t.length-1];typeof r.content=="string"&&(o=r.content)}return o}},{param:"chat_history",transform:e=>{let o=[];if(e.messages){let t=e.messages;if(t.length===1)return o;t.pop(),t.forEach(r=>{if(typeof r.content=="string"){let n="USER";r.role==="assistant"?n="CHATBOT":r.role==="system"&&(n="SYSTEM"),o.push({role:n,message:r.content})}})}return o}}],max_tokens:{param:"max_tokens",default:50,min:1},temperature:{param:"temperature",default:.3,min:0,max:5},top_p:{param:"p",default:.75,min:0,max:1},top_k:{param:"k",default:0,max:500},frequency_penalty:{param:"frequency_penalty",default:0,min:0,max:1},stop:{param:"stop_sequences"},stream:{param:"stream",default:!1},prompt_truncation:{param:"prompt_truncation",default:"OFF",required:!0}},Rn=(e,o)=>{var n;if(o!==200)return ee({message:e.message||"",type:null,param:null,code:null},j);let{input_tokens:t=0,output_tokens:r=0}=(n=e.meta)==null?void 0:n.tokens;return{id:e.response_id,object:"chat_completion",created:Math.floor(Date.now()/1e3),model:"Unknown",provider:j,choices:[{message:{role:"assistant",content:e.text},index:0,finish_reason:e.finish_reason}],usage:{prompt_tokens:t,completion_tokens:r,total_tokens:t+r}}},On=(e,o)=>{var n,s,i,a,p,l;let t=e.trim();t=t.replace(/^data: /,""),t=t.trim();let r=JSON.parse(t);return r.is_finished?"":`data: ${JSON.stringify({id:r.id??o,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:"",provider:j,choices:[{delta:{content:((i=(s=(n=r.response)==null?void 0:n.generations)==null?void 0:s[0])==null?void 0:i.text)??r.text},index:r.index??0,logprobs:null,finish_reason:((l=(p=(a=r.response)==null?void 0:a.generations)==null?void 0:p[0])==null?void 0:l.finish_reason)??null}]})}

`};var tp={chatComplete:kn,api:_n,responseTransforms:{chatComplete:Rn,"stream-chatComplete":On}},$n=tp;var rp={baseURL:"https://api.fireworks.ai/inference/v1",headers:({llmApiKey:e})=>({Authorization:`Bearer ${e}`,Accept:"application/json"}),getEndpoint:({endpoint:e})=>{switch(e){case"chatComplete":return"/chat/completions";default:return""}}},Dn=rp;var Ln={model:{param:"model",required:!0},messages:{param:"messages",required:!0,default:[]},tools:{param:"tools"},max_tokens:{param:"max_tokens",default:200,min:1},prompt_truncate_len:{param:"prompt_truncate_len",default:1500},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},top_k:{param:"top_k",min:1,max:128},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},presence_penalty:{param:"presence_penalty",min:-2,max:2},n:{param:"n",default:1,min:1,max:128},stop:{param:"stop"},response_format:{param:"response_format"},stream:{param:"stream",default:!1},context_length_exceeded_behavior:{param:"context_length_exceeded_behavior"},user:{param:"user"}},np=e=>"fault"in e?ee({message:e.fault.faultstring,type:null,param:null,code:e.fault.detail.errorcode},E):"detail"in e?ee({message:e.detail,type:null,param:null,code:null},E):ee({message:e.error,type:null,param:null,code:null},E),Nn=(e,o)=>{var t,r,n;return o!==200?np(e):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:E,choices:e.choices.map(s=>({index:s.index,message:{role:s.message.role,content:s.message.content,tool_calls:s.message.tool_calls},finish_reason:s.finish_reason})),usage:{prompt_tokens:(t=e.usage)==null?void 0:t.prompt_tokens,completion_tokens:(r=e.usage)==null?void 0:r.completion_tokens,total_tokens:(n=e.usage)==null?void 0:n.total_tokens}}:ye(e,E)},Fn=e=>{let o=e.trim();if(o=o.replace(/^data: /,""),o=o.trim(),o==="[DONE]")return`data: ${o}

`;let t=JSON.parse(o);return`data: ${JSON.stringify({id:t.id,object:t.object,created:t.created,model:t.model,provider:E,choices:[{index:t.choices[0].index,delta:t.choices[0].delta,finish_reason:t.choices[0].finish_reason}],...t.usage?{usage:t.usage}:{}})}

`};var sp={chatComplete:Ln,api:Dn,responseTransforms:{chatComplete:Nn,"stream-chatComplete":Fn}},jn=sp;var ip={baseURL:"https://api.perplexity.ai",headers:e=>({Authorization:`Bearer ${e}`,"content-type":"application/json",accept:"application/json"}),chatComplete:"/chat/completions"},Gn=ip;var Bn={model:{param:"model",required:!0,default:"llama-3.1-sonar-small-128k-chat"},messages:{param:"messages",required:!0,default:[]},max_tokens:{param:"max_tokens",required:!0,min:1},temperature:{param:"temperature",min:0,max:2},top_p:{param:"top_p",min:0,max:1},top_k:{param:"top_k",min:0,max:2048},stream:{param:"stream",default:!1},presence_penalty:{param:"presence_penalty",min:-2,max:2},frequency_penalty:{param:"repetition_penalty"},n:{param:"n",max:1,min:1}},qn=(e,o)=>{var t;return"error"in e?ee({message:e.error.message,type:e.error.type,param:null,code:e.error.code.toString()},R):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:R,choices:[{message:{role:"assistant",content:(t=e.choices[0])==null?void 0:t.message.content},index:0,logprobs:null,finish_reason:""}],usage:{prompt_tokens:e.usage.prompt_tokens,completion_tokens:e.usage.completion_tokens,total_tokens:e.usage.total_tokens}}:ye(e,R)},Un=e=>{var n,s,i;let o=e.trim();o=o.replace(/^data: /,""),o=o.trim();let t=JSON.parse(o);return`data: ${JSON.stringify({id:t.id,object:t.object,created:Math.floor(Date.now()/1e3),model:t.model,provider:R,choices:[{delta:{role:(n=t.choices[0])==null?void 0:n.delta.role,content:(s=t.choices[0])==null?void 0:s.delta.content},index:0,finish_reason:(i=t.choices[0])==null?void 0:i.finish_reason}]})}

`};var ap={chatComplete:Bn,api:Gn,responseTransforms:{chatComplete:qn,"stream-chatComplete":Un}},Hn=ap;var pp={baseURL:"https://api.mistral.ai/v1",headers:e=>({Authorization:`Bearer ${e}`}),chatComplete:"/chat/completions"},Jn=pp;var Kn={model:{param:"model",required:!0,default:"mistral-large-latest"},messages:{param:"messages",default:[]},temperature:{param:"temperature",default:.7,min:0,max:1},top_p:{param:"top_p",default:1,min:0,max:1},max_tokens:{param:"max_tokens",default:null,min:1},stream:{param:"stream",default:!1},seed:{param:"random_seed",default:null},safe_prompt:{param:"safe_prompt",default:!1},safe_mode:{param:"safe_prompt",default:!1}},Vn=(e,o)=>{var t,r,n;return"message"in e&&o!==200?ee({message:e.message,type:e.type,param:e.param,code:e.code},pe):"choices"in e?{id:e.id,object:e.object,created:e.created,model:e.model,provider:pe,choices:e.choices.map(s=>({index:s.index,message:{role:s.message.role,content:s.message.content},finish_reason:s.finish_reason})),usage:{prompt_tokens:(t=e.usage)==null?void 0:t.prompt_tokens,completion_tokens:(r=e.usage)==null?void 0:r.completion_tokens,total_tokens:(n=e.usage)==null?void 0:n.total_tokens}}:ye(e,pe)},zn=e=>{let o=e.trim();if(o=o.replace(/^data: /,""),o=o.trim(),o==="[DONE]")return`data: ${o}

`;let t=JSON.parse(o);return`data: ${JSON.stringify({id:t.id,object:t.object,created:t.created,model:t.model,provider:pe,choices:[{index:t.choices[0].index,delta:t.choices[0].delta,finish_reason:t.choices[0].finish_reason}]})}

`};var lp={chatComplete:Kn,api:Jn,responseTransforms:{chatComplete:Vn,"stream-chatComplete":zn}},Xn=lp;var mp={headers:()=>({}),getBaseURL:({providerOptions:e})=>e.customHost??"http://localhost:11434",chatComplete:"/v1/chat/completions"},Yn=mp;var Wn={model:{param:"model",required:!0,default:"llama2"},messages:{param:"messages",default:""},frequency_penalty:{param:"frequency_penalty",min:-2,max:2},presence_penalty:{param:"presence_penalty",min:-2,max:2},response_format:{param:"response_format"},seed:{param:"seed"},stop:{param:"stop"},stream:{param:"stream",default:!1},temperature:{param:"temperature",default:1,min:0,max:2},top_p:{param:"top_p",default:1,min:0,max:1},max_tokens:{param:"max_tokens",default:100,min:0}},Qn=(e,o)=>{var t,r;return o!==200?ee({message:(t=e.error)==null?void 0:t.message,type:(r=e.error)==null?void 0:r.type,param:null,code:null},K):{id:e.id,object:e.object,created:e.created,model:e.model,provider:K,choices:e.choices,usage:e.usage}},Zn=e=>{let o=e.trim();if(o=o.replace(/^data: /,""),o=o.trim(),o==="[DONE]")return`data: ${o}

`;let t=JSON.parse(o);return`data: ${JSON.stringify({id:t.id,object:t.object,created:t.created,model:t.model,provider:K,choices:t.choices})}

`};var cp={api:Yn,chatComplete:Wn,responseTransforms:{chatComplete:Qn,"stream-chatComplete":Zn}},es=cp;var dp={[T]:Cn,[q]:gn,[I]:wn,[F]:En,[_]:Tn,[j]:$n,[E]:jn,[R]:Hn,[pe]:Xn,[K]:es},Oe=dp;function os(e,o,t){let r=o.split("."),n=e;for(let s=0;s<r.length-1;s++)n[r[s]]||(n[r[s]]={}),n=n[r[s]];n[r[r.length-1]]=t}var up=({provider:e,params:o,fn:t})=>{let r=Oe[e];if(r.getConfig?r=r.getConfig(o)[t]:r=r[t],!r)throw new Error("Unsupported provider");let n={};for(let s in r){let i=r[s];Array.isArray(i)||(i=[i]);for(let a of i)if(s in o){let p=o[s];a.transform&&(p=a.transform(o)),p==="default"&&a&&a.default!==void 0&&(p=a.default),typeof p=="number"&&a&&a.min!==void 0&&p<a.min?p=a.min:typeof p=="number"&&a&&a.max!==void 0&&p>a.max&&(p=a.max),os(n,a==null?void 0:a.param,p)}else a&&a.required&&a.default!==void 0&&os(n,a.param,a.default)}return n},oe=up;async function ts({response:e,responseTransformer:o}){if(e.status===tn)return e;let t=await e.json();return u("original provider response",t),o&&(t=o(t,e.status,e.headers)),t}async function rs(e,o,t,r){let n=fp(o,r),s=Date.now().toString();if(!e.body)throw new Error("Response format is invalid. Body not found");let{readable:i,writable:a}=new TransformStream,p=a.getWriter(),l=e.body.getReader(),m=o===er,c=new TextEncoder;return(async()=>{for await(let d of gp(l,n,t,m,s))await p.write(c.encode(d));p.close()})(),[_,j,Zt].includes(o)&&t,i}var fp=(e,o)=>{let t=`

`;return e===j&&(t=`
`),e===_&&(t=`\r
`),e===R&&(t=`\r
\r
`),e===Qt&&(t=`\r
\r
`),t};async function*gp(e,o,t,r,n){let s="",i=new TextDecoder,a=!0;for(;;){let{done:p,value:l}=await e.read();if(p){s.length>0&&(t?yield t(s,n):yield s);break}for(s+=i.decode(l,{stream:!0});s.split(o).length>1;){let m=s.split(o),c=m.pop()??"";for(let d of m)if(d.length>0)if(a?(a=!1,await new Promise(f=>setTimeout(f,25))):r&&await new Promise(f=>setTimeout(f,1)),t){let f=t(d,n);f!==void 0&&(yield f)}else yield d+o;s=c}}}function ns({response:e,streamingMode:o,provider:t,responseTransformer:r,requestURL:n,modelParams:s}){var i;try{let a,p=Oe[t],l=(i=Oe[t])==null?void 0:i.responseTransforms;return p.getConfig&&(l=p.getConfig(s).responseTransforms),r&&o&&e.status===200?a=l==null?void 0:l[`stream-${r}`]:r&&(a=l==null?void 0:l[r]),u("transforming provider response using",a?`${t}${r}ResponseTransform`:"No transformer found"),o&&e.status===200?rs(e,t,a,n):ts({response:e,responseTransformer:a})}catch(a){throw console.error("An error occurred in responseHandler:",a),a}}function Ke({providerConfigMappedHeaders:e,method:o="POST"}){let t={"content-type":"application/json"},r={...e};r={...t,...r};let n={method:o,headers:r};if(o==="GET"&&n.headers){let s=n.headers;delete s["content-type"]}return n}async function se({providerOptions:e,inputParams:o,endpoint:t,transformedRequestParams:r}){let n={...o},s=!!n.stream,i=e.provider??"",a=Oe[i].api,p="",l,m;if(i===q&&a.baseURL){let f=a.headers({llmApiKey:e.llmApiKey,endpoint:t});m=Ke({providerConfigMappedHeaders:f,method:"POST"}),p=p||a.baseURL,l=a[t]||""}else i===_&&a.baseURL&&a.getEndpoint?(m=Ke({providerConfigMappedHeaders:a.headers(),method:"POST"}),p=p||a.baseURL,l=a.getEndpoint({endpoint:t,llmApiKey:e.llmApiKey,model:r.model,stream:n.stream})):i===E&&a.baseURL&&a.getEndpoint?(m=Ke({providerConfigMappedHeaders:a.headers({llmApiKey:e.llmApiKey}),method:"POST"}),p=p||a.baseURL,l=a.getEndpoint({endpoint:t})):i===K&&a.getBaseURL?(m=Ke({providerConfigMappedHeaders:a.headers(),method:"POST"}),p=a.getBaseURL({providerOptions:e}),l=a[t]||"",u("Ollama request",{baseUrl:p,providerEndpoint:l,transformedRequestParams:r})):(m=Ke({providerConfigMappedHeaders:a.headers(e.llmApiKey),method:"POST"}),p=p||a.baseURL||"",l=a[t]||"");let c=`${p}${l}`;m.body=JSON.stringify(r);let d;try{d=await fetch(c,m);let f=await ns({response:d,streamingMode:s,provider:i,responseTransformer:t,requestURL:c,modelParams:n});if(u("Transformed provider response",f),!d.ok)throw f.error;return f}catch(f){throw console.error(f),new A({code:"INTERNAL_SERVER_ERROR",message:f.message})}}function It({currentModel:e,jsonMode:o}){let t=or.includes(e);return!!(o&&t)}function O({error:e,provider:o}){throw u(`Error call-${o}.ts:`,e),new A({code:"BAD_REQUEST",message:`Error from ${o}: ${e.message}`})}function Ve(e,o){It({currentModel:e.model,jsonMode:o.json||!1})&&(e.response_format={type:"json_object"})}function ss(e,o){let t=o.model.split(":")[1];It({currentModel:t,jsonMode:o.json||!1})&&(e.generationConfig={...e.generationConfig,responseMimeType:"application/json"})}function Vo(e){let t={openai:H,anthropic:V,together:$,google:Re,groq:ce,cohere:uo,fireworks:ve,perplexity:Se,ollama:en,xai:Ko}[e.toLowerCase()];if(!t)throw new Error(`Unknown provider: ${e}`);return t}function is({provider:e,modelName:o}){return At[e].filter(n=>n.toolSupport).flatMap(n=>n.id).includes(o)}function as({provider:e,modelName:o}){var n,s;let r=At[e].filter(i=>i.toolSupport).find(i=>i.id===o);return r?{hasToolChoiceSupport:(n=r.toolSupport)==null?void 0:n.toolChoice,hasParallelToolCallSupport:(s=r.toolSupport)==null?void 0:s.parallelToolCalls}:{hasParallelToolCallSupport:!1,hasToolChoiceSupport:!1}}function Ce(e,o,t){let r=o.tools,n=t&&t.length>0;if(!n&&!r.length)return e;let[s,i]=o.model.split(":"),a=Vo(s);if(!is({modelName:i,provider:a}))return e;n&&(e.tools=t),!n&&r.length&&(e.tools=o.tools);let{hasParallelToolCallSupport:l,hasToolChoiceSupport:m}=as({modelName:i,provider:a});l&&(e.parallel_tool_calls=o.parallel_tool_calls),m&&(e.tool_choice=o.tool_choice)}async function ps({pipe:e,messages:o,llmApiKey:t,stream:r,paramsTools:n}){try{let s=hp(e,r,o);Ce(s,e,n);let i=oe({provider:q,params:s,fn:"chatComplete"});return u("Anthropic request params",i),await se({providerOptions:{provider:q,llmApiKey:t},inputParams:s,endpoint:"chatComplete",transformedRequestParams:i})}catch(s){O({error:s,provider:q})}}function hp(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r,top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}async function ls({pipe:e,messages:o,llmApiKey:t,stream:r}){try{let n=yp(e,r,o),s=oe({provider:j,params:n,fn:"chatComplete"});return u("Cohere request params",s),await se({providerOptions:{provider:j,llmApiKey:t},inputParams:n,endpoint:"chatComplete",transformedRequestParams:s})}catch(n){O({error:n,provider:j})}}function yp(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r,top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}async function ms({pipe:e,messages:o,llmApiKey:t,stream:r}){try{let n=Cp(e,r,o),s=oe({provider:E,params:n,fn:"chatComplete"});return u("Fireworks request params",s),(n==null?void 0:n.model)==="llama-v3p1-405b-instruct"&&delete s.stop,await se({providerOptions:{provider:E,llmApiKey:t},inputParams:n,endpoint:"chatComplete",transformedRequestParams:s})}catch(n){O({error:n,provider:E})}}function Cp(e,o,t){let r=e.model.split(":")[1],n=r==="yi-large"?"accounts/yi-01-ai/models/yi-large":`accounts/fireworks/models/${r}`,{top_p:s,max_tokens:i,temperature:a,presence_penalty:p,frequency_penalty:l,stop:m}=e;return{messages:t,stream:o,model:n,top_p:s,max_tokens:i,temperature:a,presence_penalty:p,frequency_penalty:l,stop:m}}async function cs({pipe:e,messages:o,llmApiKey:t,stream:r,paramsTools:n}){try{let s=bp(e,r,o);Ce(s,e,n);let i=oe({provider:_,params:s,fn:"chatComplete"});return ss(i,e),u("Google request params",i),await se({providerOptions:{provider:_,llmApiKey:t},inputParams:s,endpoint:"chatComplete",transformedRequestParams:i})}catch(s){xp(s),O({error:s,provider:_})}}function bp(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r,top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}function xp(e){e.message.includes("models/gemini-1.5-pro-latest is not found for API version v1")&&(e.message="You don't have access to gemini-1.5-pro-latest by Google Cloud AI. Contact Google support."),e.message.includes("models/gemini-1.5-flash is not found for API version v1")&&(e.message="You don't have access to gemini-1.5-flash by Google Cloud AI. Contact Google support.")}import wp from"openai";async function ds({pipe:e,messages:o,llmApiKey:t,stream:r}){try{let n=Pp(e,r,o),s=new wp({apiKey:t,baseURL:"https://api.groq.com/openai/v1"});Ve(n,e);let i=oe({provider:F,params:n,fn:"chatComplete"});return u("Groq request params",i),await s.chat.completions.create(i)}catch(n){O({error:n,provider:F})}}function Pp(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r,top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}async function us({pipe:e,messages:o,llmApiKey:t,stream:r}){try{let n=vp(e,r,o),s=oe({provider:K,params:n,fn:"chatComplete"});return u("ollama request params",s),await se({providerOptions:{provider:K,llmApiKey:t},inputParams:n,endpoint:"chatComplete",transformedRequestParams:s})}catch(n){O({error:n,provider:K})}}function vp(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r,top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}import Ep from"openai";import"openai";async function fs({openai:e,prompt:o}){let t="";if(o.messages&&o.messages.length>0)for(let s of o.messages)t+=s.content+`
`;if(o.variables&&o.variables.length>0)for(let s of o.variables)t+=`${s.name}: ${s.value}
`;let r=await e.moderations.create({model:"omni-moderation-latest",input:t}),n=r==null?void 0:r.results[0];if(n.flagged){let i=Object.entries(n.categories).filter(([,a])=>a===!0).map(([a])=>a.replace("/"," or ")).join(", ");return{flagged:n.flagged,reason:`Content flagged by OpenAI moderation endpoint due to: ${i}`}}return{flagged:n.flagged,reason:"Content passed OpenAI moderation successfully"}}async function gs({pipe:e,stream:o,llmApiKey:t,messages:r,paramsTools:n}){try{Sp(e,r);let s=new Ep({apiKey:t});await Mp(s,r,e.moderate);let i=Ap(e,o,r);return Ce(i,e,n),Ve(i,e),u("modelParams",i),await s.chat.completions.create(i)}catch(s){O({error:s,provider:T})}}function Sp(e,o){if(!e||!e.model||!o||o.length===0)throw new A({code:"BAD_REQUEST",message:"Invalid input: pipe or messages are missing or empty"})}async function Mp(e,o,t=!0){if(t){let{flagged:r,reason:n}=await fs({openai:e,prompt:{messages:o,variables:[]}});if(r)throw new A({code:"BAD_REQUEST",message:n})}}function Ap(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r||"gpt-4o-mini",top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}async function hs({pipe:e,messages:o,llmApiKey:t,stream:r}){try{let n=Ip(e,r,o),s=oe({provider:R,params:n,fn:"chatComplete"});return u("Perplexity request params",s),await se({providerOptions:{provider:R,llmApiKey:t},inputParams:n,endpoint:"chatComplete",transformedRequestParams:s})}catch(n){O({error:n,provider:R})}}function Ip(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r,top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}import Tp from"openai";async function ys({pipe:e,messages:o,llmApiKey:t,stream:r,paramsTools:n}){try{let s=_p(e,r,o),i=new Tp({apiKey:t,baseURL:"https://api.together.xyz/v1"});return delete s.stop,Ve(s,e),Ce(s,e,n),u("modelParams",s),await i.chat.completions.create(s)}catch(s){O({error:s,provider:F})}}function _p(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r,top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}import kp from"openai";async function Cs({pipe:e,stream:o,llmApiKey:t,messages:r,paramsTools:n}){try{let s=Rp(e,o,r),i=new kp({apiKey:t,baseURL:"https://api.x.ai/v1"});return Ce(s,e,n),u("modelParams",s),await i.chat.completions.create(s)}catch(s){O({error:s,provider:Ne})}}function Rp(e,o,t){let r=e.model.split(":")[1],{top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}=e;return{messages:t,stream:o,model:r,top_p:n,max_tokens:s,temperature:i,presence_penalty:a,frequency_penalty:p,stop:l}}async function bs({pipe:e,stream:o,messages:t,llmApiKey:r,variables:n,paramsTools:s}){try{let i=e.model.split(":")[0],a=Vo(i),p=e.memory.map(c=>c.name),l=await xr({messages:t,memoryNames:p});if(t=pn({pipe:e,messages:t,similarChunks:l,variables:n}),u("Messages for LLM",t),a===T)return u("OPEN_AI","\u2705"),await gs({pipe:e,stream:o,messages:t,llmApiKey:r,paramsTools:s});if(a===q)return u("ANTHROPIC","\u2705"),await ps({pipe:e,stream:o,messages:t,llmApiKey:r,paramsTools:s});if(a===I)return u("TOGETHER_AI","\u2705"),await ys({pipe:e,stream:o,messages:t,llmApiKey:r,paramsTools:s});if(a===F)return u("GROQ","\u2705"),await ds({pipe:e,messages:t,llmApiKey:r,stream:o});if(a===_)return u("GOOGLE","\u2705"),await cs({pipe:e,messages:t,llmApiKey:r,stream:o,paramsTools:s});if(a===Ne)return u("XAI","\u2705"),await Cs({pipe:e,messages:t,llmApiKey:r,stream:o,paramsTools:s});if(a===j)return u("COHERE","\u2705"),await ls({pipe:e,messages:t,llmApiKey:r,stream:o});if(a===E)return u("FIREWORKS_AI","\u2705"),await ms({pipe:e,messages:t,llmApiKey:r,stream:o});if(a===R)return u("PERPLEXITY","\u2705"),await hs({pipe:e,messages:t,llmApiKey:r,stream:o});if(a===K)return u("OLLAMA","\u2705"),await us({pipe:e,messages:t,llmApiKey:r,stream:o});throw new A({status:400,code:"BAD_REQUEST",message:`Invalid model provider: ${a}`})}catch(i){throw u("Error call-llm.ts:",i),i.status===429?new A({status:429,code:"RATE_LIMITED",message:`Rate limited by the model provider. Please try again later. ${i.message}`}):new A({status:i.status,code:i.code||"INTERNAL_SERVER_ERROR",message:i.message?i.message:"Error calling the model provider."})}}var xs=async({c:e,response:o,headers:t})=>{try{if(o instanceof ReadableStream){let[r]=o.tee();return new Response(r,{headers:{"content-type":"text/event-stream",...t}})}else{let r=new ReadableStream({async start(n){let s=new TextEncoder;try{for await(let i of o){let a=JSON.stringify(i);n.enqueue(s.encode(`data: ${a}

`))}}catch(i){console.error("Error processing stream:",i),n.error(i)}finally{n.enqueue(s.encode(`data: [DONE]

`)),n.close()}}});return new Response(r,{headers:{"content-type":"text/event-stream",...t}})}}catch(r){throw console.error("Error in handleStreamingResponse:",r),new A({code:"INTERNAL_SERVER_ERROR",message:`Error while streaming: ${r}`})}};import"hono";import{z as D}from"zod";var Tt=D.object({role:D.enum(["system","user","assistant","function","tool"]),content:D.string().nullable(),tool_call_id:D.string().optional(),name:D.string().optional(),tool_calls:D.array(D.object({id:D.string(),type:D.string(),function:D.record(D.unknown())})).optional()}).refine(({content:e,role:o,tool_calls:t})=>!(e===null&&o!=="assistant"&&!t),{message:"Message content cannot be empty."}),Op=D.object({name:D.string(),value:D.string()}),_t=D.array(Op).default([]),$p=/^[a-zA-Z_$][a-zA-Z0-9_$]*$/,ws=D.object({type:D.enum(["function"]).default("function"),function:D.object({name:D.string().refine(e=>$p.test(e))})}).optional();import{z as $e}from"zod";var kt=$e.object({type:$e.literal("function"),function:$e.object({name:$e.string(),description:$e.string().optional(),parameters:$e.record($e.any()).optional()})});import{z as C}from"zod";var Dp=C.object({name:C.string(),description:C.string(),status:C.enum(["public","private"]),model:C.string(),stream:C.boolean(),json:C.boolean(),store:C.boolean(),moderate:C.boolean(),top_p:C.number(),max_tokens:C.number(),temperature:C.number(),presence_penalty:C.number(),frequency_penalty:C.number(),stop:C.array(C.string()),tool_choice:C.union([C.enum(["auto","required","none"]),ws]).default("auto"),parallel_tool_calls:C.boolean(),messages:C.array(Tt),variables:_t,tools:C.array(kt).default([]),memory:C.array(C.object({name:C.string().trim().min(1)})).default([])}),Lp=C.object({pipe:Dp,stream:C.boolean(),messages:C.array(Tt),llmApiKey:C.string(),tools:C.array(kt).optional(),variables:_t.optional()}),Np=e=>{let o=Lp.safeParse(e);if(!o.success)throw new Je({code:"BAD_REQUEST",validationResult:o,customMessage:"Invalid request body"});return o.data},Fp=(e,o,t)=>{var n,s,i,a,p;let r=o.stream;if(!r&&((n=t==null?void 0:t.choices)==null?void 0:n.length)>0){let l=((i=(s=t.choices[0])==null?void 0:s.message)==null?void 0:i.content)??"",m=((p=(a=t.choices[0])==null?void 0:a.message)==null?void 0:p.tool_calls)??[],c=m.length>0;return ge("tool",c,"Tool calls found"),ge("tool.calls",m),ge("pipe.completion",l,"Pipe completion"),ge("pipe.response",t,"type: (non-streaming)"),e.json({completion:l,...t})}return r?(ge("pipe.response",t,"type: (streaming)"),xs({response:t,headers:{},c:e})):e.json({body:o})},jp=(e,o)=>{if(o instanceof Je)throw o;let t=o instanceof Error?o.message:"Unexpected error occurred in /pipe/v1/run";throw u("Error /pipe/v1/run.ts:",o),new A({status:o instanceof A?o.status:500,code:o instanceof A?o.code:"INTERNAL_SERVER_ERROR",message:t,docs:o instanceof A?o.docs:void 0})},Gp=async e=>{try{let o=await e.req.json(),t=o.llmApiKey||"",r=new Array(45).fill("*").join(""),n=t.length?t.slice(0,8)+r:"",s={...o,llmApiKey:n};ge("pipe.request",s,"Pipe Request Body");let i=Np(o),{pipe:a,messages:p,llmApiKey:l,stream:m,variables:c}=i,d=a.model,f=await bs({pipe:{...a,model:d},messages:p,llmApiKey:l,stream:m,variables:c,paramsTools:i.tools});return Fp(e,i,f)}catch(o){return jp(e,o)}},Ps=e=>{e.post("/v1/pipes/run",Gp)};async function vs(){let e=new Hp;e.use(Kp()),e.use("*",Xr),e.use(Jp()),e.use(Yr()),e.use(Wr()),e.onError((t,r)=>zr(t,r)),Qr(e),Ps(e);let o=9e3;try{be.intro(h({text:"DEV",sub:"BaseAI dev server"}));let t=qp({fetch:e.fetch,port:o});t.on("error",r=>{r.code==="EADDRINUSE"?(be.log.error(zo.red(`Error: Port ${o} is already in use.`)),be.log.info("Please close the other application using 9000 port. And try again."),process.exit(1)):(console.error("Unexpected server error:",r),process.exit(1))}),t.on("listening",()=>{Bp(`BaseAI server running on: ${zo.green(`http://localhost:${o}`)}`),console.log(`When needed you can press ${zo.cyan("Ctrl + C")} to shut down.`)}),process.on("SIGINT",()=>{let r=be.spinner();r.start("Shutting down server"),t.close(()=>{r.stop("Shutting down the server \u2026"),be.outro(`${zo.green(Up.tick)} BaseAI server has been gracefully shut down.`),process.exit(0)})})}catch(t){be.outro(`Error: Unable to start server. ${t.message}`),process.exit(1)}}import{detect as Vp}from"@antfu/ni";import*as w from"@clack/prompts";import{execa as Ot}from"execa";import de from"fs/promises";import ze from"path";import Rt from"picocolors";function De({errorMessage:e,warningMessage:o}){w.log.error(`Setup failed: ${e}`),w.log.warn(o),w.cancel("Setup aborted."),process.exit(1)}async function zp({calledAsCommand:e}){e&&w.intro(h({text:"SETUP",sub:"Setting up BaseAI"}))}async function Xp(){if(!await $t("package.json")){let o=await w.confirm({message:`No ${Rt.red("package.json")} found. Would you like to create one using ${Rt.cyan(Rt.bold("npm init -y"))}?`});w.isCancel(o)&&(w.cancel("Operation cancelled."),process.exit(0)),o||De({errorMessage:"Cannot proceed without a package.json file.",warningMessage:"Run the command in a directory with a package.json file or allow the setup to create one."});try{await Ot("npm",["init","-y"]),w.log.success("Created package.json file.")}catch(t){De({errorMessage:`Failed to create package.json: ${t instanceof Error?t.message:String(t)}`,warningMessage:"Ensure you have permission to create files in this directory and npm is installed."})}}}async function Yp(e){let o=await Vp({programmatic:!0,cwd:e});return o==="yarn@berry"?"yarn":o==="pnpm@6"?"pnpm":o==="bun"?"bun":o??"npm"}async function Ms(){try{let e=JSON.parse(await de.readFile("package.json","utf-8")),o="baseai"in(e.devDependencies||{}),t="@baseai/core"in(e.dependencies||{});return o&&t}catch{return!1}}async function Wp(e){if(await Ms())return;let t=w.spinner();t.start("Installing BaseAI");let r={npm:"install",yarn:"add",pnpm:"add",bun:"add"}[e];try{await Ot(e,[r,"@baseai/core"]),await Ot(e,[r,"baseai","--save-dev"]),t.stop("BaseAI installed successfully.")}catch(n){De({errorMessage:`BaseAI installation failed: ${n instanceof Error?n.message:String(n)}`,warningMessage:"Ensure you have an active internet connection and the necessary permissions to install packages."})}}async function Es(e){try{return await de.access(e),!1}catch{return await de.mkdir(e,{recursive:!0}),!0}}async function $t(e){try{return await de.access(e),!0}catch{return!1}}async function Qp(){let e=ze.join(process.cwd(),"baseai"),o=ze.join(process.cwd(),".baseai");try{let t=await Es(e),r=await Es(o);t&&r&&w.log.success("Added `baseai` directory to your project.")}catch(t){De({errorMessage:`Error setting up directories: ${t instanceof Error?t.message:String(t)}`,warningMessage:"Ensure you have permission to create directories in this location."})}}async function Zp(){let e=ze.join(process.cwd(),"baseai","baseai.config.ts");if(!await $t(e)){let t=`
import type {BaseAIConfig} from 'baseai';

export const config: BaseAIConfig = ${JSON.stringify(We,null,2)};
`;try{let r=await we(t);await de.writeFile(e,r),w.log.success("Created `baseai.config.ts` with default configuration.")}catch(r){De({errorMessage:`Failed to create baseai.config.ts: ${r instanceof Error?r.message:String(r)}`,warningMessage:"Ensure you have permission to create files in the baseai directory."})}}}async function el(){try{let e=ze.join(process.cwd(),"package.json"),o=await de.readFile(e,"utf-8"),t=JSON.parse(o);t.scripts||(t.scripts={}),(!t.scripts.baseai||t.scripts.baseai!=="baseai")&&(t.scripts.baseai="baseai",await de.writeFile(e,JSON.stringify(t,null,2)),w.log.success('Added "baseai" script in package.json'))}catch(e){De({errorMessage:`Failed to update package.json: ${e instanceof Error?e.message:String(e)}`,warningMessage:"Ensure you have permission to modify the package.json file."})}}function ol({calledAsCommand:e}){e?(w.outro("All good. BaseAI setup completed successfully!"),w.log.warning(te(`Make sure to set environment variables like mentioned in the ${X(".env.baseai.example")} file added to your project root.`))):console.log()}async function Ss({gitignoreEntry:e}){let o=ze.join(process.cwd(),".gitignore");try{let t="";try{t=await de.readFile(o,"utf-8")}catch{await de.writeFile(o,e);return}if(!t.includes(e)){let r=t.endsWith(`
`)?t+e:t+`
`+e;await de.writeFile(o,r)}}catch(t){w.log.error(`Error updating .gitignore: ${t instanceof Error?t.message:String(t)}`)}}async function tl(){let e=ze.join(process.cwd(),".env.baseai.example"),o=`# !! SERVER SIDE ONLY !!
# Keep all your API keys secret \u2014 use only on the server side.

# TODO: ADD: Both in your production and local env files.
# Langbase API key for your User or Org account.
# How to get this API key https://langbase.com/docs/api-reference/api-keys
LANGBASE_API_KEY=

# TODO: ADD: LOCAL ONLY. Add only to local env files.
# Following keys are needed for local pipe runs. For providers you are using.
# For Langbase, please add the key to your LLM keysets.
# Read more: Langbase LLM Keysets https://langbase.com/docs/features/keysets
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
COHERE_API_KEY=
FIREWORKS_API_KEY=
GOOGLE_API_KEY=
GROQ_API_KEY=
MISTRAL_API_KEY=
PERPLEXITY_API_KEY=
TOGETHER_API_KEY=
XAI_API_KEY=
`;try{await $t(e)||await de.writeFile(e,o)}catch(t){w.log.error(`Error creating .env.baseai.example: Check the example env file here https://github.com/LangbaseInc/baseai/blob/main/.env.baseai.example
 Error: ${t instanceof Error?t.message:String(t)}`)}}async function Dt({calledAsCommand:e=!1,debug:o=!1}={}){let t=()=>{console.log(`
Interrupted. Cleaning up...`),process.exit(0)};process.on("SIGINT",t);try{await zp({calledAsCommand:e}),await Xp();let r=await Yp(process.cwd());if(e&&w.log.info(`Detected package manager: ${r}`),!await Ms()){let s=await w.confirm({message:"BaseAI is not installed but required to run. Would you like to install it?"});w.isCancel(s)&&(w.cancel("Operation cancelled."),process.exit(0)),s?await Wp(r):De({errorMessage:"BaseAI packages are required for setup.",warningMessage:"Run the setup again and allow installation of BaseAI packages to continue."})}await Qp(),await Zp(),await el(),await Ss({gitignoreEntry:`# baseai
**/.baseai/
`}),await Ss({gitignoreEntry:`# env file
.env
`}),await tl(),ol({calledAsCommand:e})}catch(r){o&&console.error("Error:",r),w.cancel(`baseai init error ${r.message?r.message:r}`),process.exit(1)}finally{process.off("SIGINT",t)}}import*as G from"@clack/prompts";import rl from"@sindresorhus/slugify";import nl from"camelcase";import sl from"figures";import go from"fs";import ho from"path";import{fromZodError as il}from"zod-validation-error";import{exec as al}from"child_process";import{promisify as pl}from"util";var ll=pl(al),As={name:"ai-agent-memory",description:"My list of docs as memory for an AI agent pipe"},Is={documentsDir:"documents"};async function Ts(){G.intro(h({text:"MEMORY",sub:"Create a new memory"}));let e=await G.group({name:()=>G.text({message:"Name of the memory",placeholder:As.name,validate:p=>{let l=to.safeParse(p);if(!l.success)return il(l.error).toString()}}),description:()=>G.text({message:"Description of the memory",placeholder:As.description}),useGit:()=>G.confirm({message:"Do you want to create memory from current project git repository?",initialValue:!1})},{onCancel:()=>{G.cancel("Operation cancelled."),process.exit(0)}}),o=rl(e.name),t=nl("memory-"+o),r=ho.join(process.cwd(),"baseai","memory"),n=ho.join(r,o),s=ho.join(n,"index.ts"),i=ho.join(process.cwd(),".baseai","db");if(e.useGit)try{await ll("git rev-parse --is-inside-work-tree")}catch{G.cancel("The current directory is not a Git repository."),process.exit(1)}let a=`import {MemoryI} from '@baseai/core';

const ${t} = (): MemoryI => ({
	name: '${o}',
	description: ${JSON.stringify(e.description||"")},
	git: {
		enabled: ${e.useGit},${e.useGit?`
		include: ['**/*'],
		gitignore: true,`:`
		include: ['${Is.documentsDir}/**/*'],
		gitignore: false,`}
		deployedAt: '',
		embeddedAt: ''
	}
});

export default ${t};`;try{if(await go.promises.mkdir(r,{recursive:!0}),await go.promises.mkdir(n,{recursive:!0}),await go.promises.writeFile(s,a),await go.promises.mkdir(i,{recursive:!0}),e.useGit)G.note(["All files in this Git repository will be tracked by default.","","To modify which files are being tracked, update the config at:",X(s)].join(`
`));else{let p=ho.join(n,Is.documentsDir);await go.promises.mkdir(p,{recursive:!0}),G.note(`Add documents in baseai/memory/${o}/${X("documents")} to use them in the memory.`)}await ct(o),G.outro(h({text:t,sub:`created as a new memory 
 ${xe(sl.pointer)} ${te(` ${s}`)}`,green:!0})),process.exit(0)}catch(p){G.cancel(`Error creating memory: ${p.message}`),process.exit(1)}}import*as Y from"@clack/prompts";import _s from"picocolors";async function Xo({memoryName:e,overwrite:o,useLocalEmbeddings:t}){let r=Y.spinner();try{Y.intro(h({text:"EMBED",sub:`Creating embeddings of ${_s.cyan(e)}`})),e||(Y.cancel("Memory name is required. Use --memory or -m flag to specify."),process.exit(1));let n=Lo(e);await He(n),r.start("Processing memory docs...");let s=await Pe(n);s.length===0&&(Y.cancel(`No valid documents found in memory '${n}'.`),process.exit(1));let i=await no(n),a=[],p=[];if(i.git.enabled){let{filesToDeploy:m,filesToDelete:c}=await qo({memoryName:n,config:i});a=m,p=c,s=s.filter(d=>a.includes(d.name))}let l="Embeddings updated.";if(s&&s.length>0){r.message("Generating embeddings...");let m=i.git.enabled?!0:o;l=await Bo({memoryFiles:s,memoryName:n,overwrite:m||!1,useLocalEmbeddings:t})}i.git.enabled&&(p.length>0&&await ml({memoryName:n,filesToDelete:p}),await Dr(n),Y.log.info("Updated embedded commit hash."),Y.log.success("Synced memory files with git repository.")),r.stop(l)}catch(n){r.stop("Stopped!"),Y.cancel(`FAILED: ${n.message}`),process.exit(1)}}async function ml({memoryName:e,filesToDelete:o}){let t=Y.spinner();t.start("Detected files to delete. Deleting...");try{let r=await Fe(e);for(let n of o)r.data.documents[n]&&(await Ro({db:r,docName:n}),Y.log.info(`Deleted document: ${_s.cyan(n)}`));t.stop(`Documents deleted from memory ${e}.`)}catch(r){t.stop("Stopped!"),r instanceof Error?Y.cancel(`Failed to delete documents: ${r.message}`):Y.cancel("Failed to delete documents. An unknown error occurred."),process.exit(1)}}import*as Yo from"@clack/prompts";import ks from"picocolors";async function Rs({memoryName:e,documentName:o,overwrite:t=!1}){Yo.intro(h({text:"EMBED DOC",sub:`Creating embeddings of Doc: ${ks.cyan(o)} in memory ${ks.cyan(e)}`}));let r=Yo.spinner();try{let{memoryFile:n,validMemoryName:s}=await Uo({spinner:r,memoryName:e,documentName:o});r.message("Generating embeddings...");let i=await Bo({memoryFiles:[n],memoryName:s,overwrite:t||!1});r.stop(i)}catch(n){r.stop(`FAILED from here: ${n.message}`),process.exit(1)}}import cl from"path";import Os from"fs";async function Xe(){try{let e=cl.join(process.cwd(),"baseai","memory");return Os.existsSync(e)?await Os.promises.readdir(e):[]}catch{return[]}}import*as Wo from"@clack/prompts";async function $s(){let e=await Xe();if(e.length===0){Wo.log.message("No memory available.");return}Wo.intro(h({text:"MEMORY",sub:"List of all available memory sets"})),console.log(""),e.forEach(o=>{console.log(`${Ee.memory} ${o}`)}),process.exit(0)}import Qo from"picocolors";import*as J from"@clack/prompts";async function Ds({memory:e,query:o}){var r;J.intro(h({text:"RETRIEVE",sub:"Retrieve similar chunks of a memory"}));let t=J.spinner();try{e||(J.log.error("Memory name is required. Use --memory or -m flag to specify."),process.exit(1)),o||(J.log.error("Query is required. Use --query, or -q flag to specify."),process.exit(1));let n=Lo(e);await He(n),t.start("Processing memory data...");let s=await Oo([e]);if(s.length===0)return J.log.error("Please make sure the memory has one or more documents and they are embedded.");t.message("Generating embeddings...");let a=((r=(await W()).memory)==null?void 0:r.useLocalEmbeddings)||!1,p=[];a?(u("Generating local embeddings"),p=await Ge([o])):(u("Generating OpenAI embeddings"),p=await Be([o])),t.message("Searching for similar chunks...");let l=$o({chunks:s,queryEmbedding:p[0].embedding,topK:P.MAX_CHUNKS_ATTACHED_TO_LLM});if(l.length===0)return J.log.message("No similar chunks found.");J.log.info("Similar Chunks:"),l.forEach((m,c)=>{let d=Qo.cyan(Qo.bold(`#${c+1}`)),f=`Similarity: ${Qo.green(m.similarity.toFixed(6))}`,b=`Source: ${m.attributes.docName}`,x=m.text;J.note(`${d}
${f}
${b}`),J.log.message(`${Qo.cyan("Text Chunk:")}
${x}
`)}),J.outro("Memory retrieval completed successfully.")}catch(n){J.cancel(`FAILED: ${n.message}`)}finally{t.stop("Finished")}}import*as B from"@clack/prompts";import dl from"@sindresorhus/slugify";import Zo from"camelcase";import ul from"figures";import Ls from"fs";import Ns from"path";import{z as fl}from"zod";var gl=fl.string().min(3,"Pipe name must be at least 3 characters long").max(50,"Pipe name must not exceed 50 characters").regex(/^[a-zA-Z0-9.-]+$/,"Pipe name can only contain letters, numbers, dots, and hyphens"),Fs=`${te("(optional)")} 
${te(`${jt} Press ${X("space")} to select, ${X("enter")} to submit or skip`)}`;async function js(){let e=await Le(),o=await Xe(),t=e.length>0,r=o.length>0;B.intro(h({text:"PIPE",sub:"Create a new agent pipe"}));let n=await B.group({name:()=>B.text({message:"Name of the pipe",placeholder:"ai-agent-pipe",validate:S=>{let ae=gl.safeParse(S);if(!ae.success)return ae.error.issues[0].message}}),description:()=>B.text({message:"Description of the pipe",placeholder:"This is a test pipe"}),status:()=>B.select({message:"Status of the pipe",options:[{value:"public",label:"Public"},{value:"private",label:"Private"}]}),systemPrompt:()=>B.text({message:"System prompt",placeholder:"You are a helpful AI assistant.",initialValue:"You are a helpful AI assistant."}),...r&&{memory:async()=>B.multiselect({message:`Select memory for this pipe ${Fs}`,options:o.map(S=>({value:S,label:S})),required:!1})},...t&&{tools:async()=>B.multiselect({message:`Select tools for this pipe ${Fs}`,options:e.map(S=>({value:S,label:S})),required:!1})}},{onCancel:()=>{B.cancel("Operation cancelled."),process.exit(0)}}),s="",i=[],a=n.tools;a&&a.map(S=>{let ae=`${Zo(S)}Tool`;i.push(`${ae}()`),s+=`
import ${ae} from '../tools/${S}';`});let p="",l=[],m=n.memory;m&&m.map(S=>{let ae=`${Zo(S)}Memory`;l.push(`${Zo(S)}Memory()`),p+=`
import ${ae} from '../memory/${S}';`});let c=l.length>0,d=dl(n.name),f=Zo("pipe-"+n.name),b=`import { PipeI } from '@baseai/core';${s}${p}

const ${f} = (): PipeI => ({
    // Replace with your API key https://langbase.com/docs/api-reference/api-keys
	apiKey: process.env.LANGBASE_API_KEY!,
    name: '${d}',
    description: ${JSON.stringify(n.description)||""},
    status: '${n.status}',
    model: 'openai:gpt-4o-mini',
    stream: true,
    json: false,
    store: true,
    moderate: true,
    top_p: 1,
    max_tokens: 1000,
    temperature: 0.7,
    presence_penalty: 1,
    frequency_penalty: 1,
    stop: [],
    tool_choice: 'auto',
    parallel_tool_calls: true,
    messages: [
        { role: 'system', content: \`${n.systemPrompt}\` },
        ${c?`{ role: 'system', name: 'rag', content: "${eo.replace(/\n/g,"\\n")}" }`:""}
    ],
    variables: [],
    memory: [${l.join(", ")}],
    tools: [${i.join(", ")}],
});

export default ${f};
    `,x=await we(b),fe=Ns.join(process.cwd(),"baseai","pipes"),Ye=Ns.join(fe,`${d}.ts`);try{await Ls.promises.mkdir(fe,{recursive:!0}),await Ls.promises.writeFile(Ye,x),B.outro(h({text:f,sub:`created as a new pipe 
 ${xe(ul.pointer)} ${te(` ${Ye}`)}`,green:!0})),process.exit(0)}catch(S){B.cancel(`Error creating pipe: ${S.message}`),process.exit(1)}}import*as ie from"@clack/prompts";import hl from"@sindresorhus/slugify";import Gs from"camelcase";import yl from"figures";import Bs from"fs";import qs from"path";import Cl from"picocolors";import{z as bl}from"zod";var Us={type:"function",function:{name:"get_current_weather",description:"Get the current weather in a given location",parameters:{type:"object",properties:{location:{type:"string",description:"The city and state, e.g. San Francisco, CA"},unit:{type:"string",enum:["celsius","fahrenheit"]}},required:["location"]}}},xl=bl.string().min(3,"Tool name must be at least 3 characters long").max(50,"Tool name must not exceed 50 characters");async function Hs(){let e=await Le();ie.intro(h({text:"TOOL",sub:"Create a new tool"}));let o=await ie.group({name:()=>ie.text({message:"Name of the tool",placeholder:Us.function.name,validate:m=>{let c=xl.safeParse(m);if(!c.success)return c.error.issues[0].message;if(wo({name:m,allTools:e}))return`Tool with name ${m} already exists!`}}),description:()=>ie.text({message:"Description of the tool",placeholder:Us.function.description,validate(m){if(m.length===0)return"Tool description is required!"}})},{onCancel:()=>{ie.cancel("Operation cancelled."),process.exit(0)}}),t=hl(o.name),r=Gs("tool-"+o.name),n=Gs(o.name),s=o.description||"",i=`import { ToolI } from '@baseai/core';

export async function ${n}() {
	// Add your tool logic here
	// This function will be called when the tool is executed
}

const ${r} = (): ToolI => ({
	run: ${n},
	type: 'function' as const,
	function: {
		name: '${r}',
		description: ${JSON.stringify(s)||""},
		parameters: {},
	},
});

export default ${r};
`,a=qs.join(process.cwd(),"baseai","tools"),p=qs.join(a,`${t}.ts`),l=await we(i);try{await Bs.promises.mkdir(a,{recursive:!0}),await Bs.promises.writeFile(p,l),ie.outro(h({text:r,sub:`created as a new tool 
 ${Cl.dim(`${yl.pointer} ${p}`)}`,green:!0})),process.exit(0)}catch(m){ie.cancel(`Error creating tool: ${m.message}`),process.exit(1)}}import wl from"cli-meow-help";import Pl from"meow";var Js={clear:{type:"boolean",default:!1,desc:"Clear the console"},debug:{type:"boolean",default:!1,shortFlag:"d",desc:"Print debug info"},memory:{type:"string",shortFlag:"m",desc:"Memory to use"},overwrite:{type:"boolean",shortFlag:"o",desc:"Overwrite existing memory embeddings"},document:{type:"string",shortFlag:"d",desc:"Document to embed"},query:{type:"string",shortFlag:"q",desc:"Query string"},list:{type:"boolean",shortFlag:"l",desc:"List available memory"},local:{type:"boolean",shortFlag:"L",desc:"Set use local embeddings (true/false)"}},vl={dev:{desc:"Run BaseAI in dev mode"},auth:{desc:"Authenticate with Langbase"},add:{desc:"Add an agent Pipe from Langbase"},deploy:{desc:"Deploy BaseAI to Langbase"},pipe:{desc:"Create a pipe"},tool:{desc:"Create a tool"},memory:{desc:"Create a memory"},embed:{desc:"Create embeddings of a memory"},retrieve:{desc:"Retrieve similar chunks of a memory"},config:{desc:"Configure BaseAI",subcommands:{embeddings:{desc:"Enable or disable local embeddings"}}},build:{desc:"Build BaseAI files"},init:{desc:"Set up BaseAI files and add packages"},help:{desc:"Print help info"}},El=wl({name:"baseai",flags:Js,commands:vl,desc:!1,header:!1,footer:"Made by Langbase. For more https://langbase.com/docs"}),Sl={importMeta:import.meta,inferType:!0,description:!1,hardRejection:!1,flags:Js},Lt=Pl(El,Sl);import*as yo from"@clack/prompts";import Ks from"fs/promises";import Vs from"path";var Ml=Vs.join(process.cwd(),"baseai"),Nt=Vs.join(Ml,"baseai.config.ts");async function zs(e){try{yo.intro(h({text:"CONFIG",sub:"Configure embeddings"}));let o=await Ks.readFile(Nt,"utf-8"),t=o.match(/(["']?useLocalEmbeddings["']?\s*:\s*)(true|false)/);if(!t)return console.log("useLocalEmbeddings not found in the config file."),null;let r=t[2]==="true",n=o.replace(/(["']?useLocalEmbeddings["']?\s*:\s*)(true|false)/,`$1${e}`);if(await Ks.writeFile(Nt,n.trim()),e===r){console.log(`
useLocalEmbeddings is already set to ${e}.
`);return}console.log(`
Updated useLocalEmbeddings to ${e} successfully in ${Nt}`);let i=r===!0?"local Ollama":"OpenAI",a=e===!0?"local Ollama":"OpenAI";yo.log.info(`
Switching from ${i} embeddings to ${a} embeddings.
`);let p=await Xe();for(let l of p)await Xo({memoryName:l,overwrite:!0,useLocalEmbeddings:e});yo.log.info("Please restart the dev server to apply the changes to the memory embeddings configuration.")}catch(o){console.error(`Error updating useLocalEmbeddings: ${o.message}`)}}import*as Co from"@clack/prompts";function Ft(e){Co.intro(h({text:"DEBUG MODE",sub:"logs will be verbose...",dim:!0})),console.log(),Co.intro(h({text:"cwd",dim:!0})),console.log(process.cwd()),console.log(),Co.intro(h({text:"cli.flags",dim:!0})),console.log(e.flags),console.log(),Co.intro(h({text:"cli.input",sub:"commands",dim:!0})),console.log(e.input),console.log()}import Al from"cli-handle-unhandled";import Il from"cli-welcome";import Xs from"path";import{fileURLToPath as Tl}from"url";import Ys from"fs";var Ws=async({clear:e=!1})=>{Al();let o=Tl(import.meta.url),t=Xs.dirname(o),r=Xs.join(t,"..","package.json");Ys.existsSync(r)||(console.error("Unable to find package.json"),process.exit(1));let n=JSON.parse(Ys.readFileSync(r,"utf8"));await Il({title:"baseai",tagLine:"by Langbase",description:n.description,version:n.version,bgColor:"#A699EA",color:"#000000",bold:!0,clear:e})};var{flags:z,input:Qs,showHelp:Rl}=Lt,{clear:Ol,debug:bo}=z,k=e=>Qs.includes(e),ue=e=>!!z[e];(async()=>{await Ws({clear:Ol}),bo&&Ft(Lt),bo&&console.log("Checking if baseai is initialized"),k("init")?await Dt({calledAsCommand:!0,debug:bo}):await Dt({calledAsCommand:!1,debug:bo});let e=await W();if(_l.config({path:kl.resolve(process.cwd(),e.envFilePath)}),bo&&console.log("Initializing logger"),await fr(),k("help")&&Rl(0),k("auth")&&await Xt(),k("dev")&&await vs(),k("pipe")&&await js(),k("tool")&&await Hs(),k("build")&&await Mo({calledAsCommand:!0}),k("deploy")&&!ue("memory")&&!ue("document")&&await Gr({overwrite:z.overwrite}),k("deploy")&&ue("memory")&&!ue("document")&&await Jr({memoryName:z.memory,overwrite:z.overwrite}),k("deploy")&&ue("memory")&&ue("document")&&await Fr({memoryName:z.memory,documentName:z.document,overwrite:z.overwrite}),k("memory")&&ue("list")&&await $s(),k("memory")&&!ue("list")&&await Ts(),k("embed")&&ue("document")&&ue("memory")&&await Rs({memoryName:z.memory,documentName:z.document,overwrite:z.overwrite}),k("embed")&&!ue("document")&&await Xo({memoryName:z.memory,overwrite:z.overwrite}),k("retrieve")&&await Ds({memory:z.memory,query:z.query}),k("config")&&k("embeddings")&&await zs(z.local),k("add")||k("a")||k("clone")||k("install")||k("i")){let[o,t]=Qs;await Jt({loginAndPipe:t})}})();
//# sourceMappingURL=index.js.map